import{E as e}from"./eventemitter3-91a3dd57.js";import{c as t,E as r,L as n,S as i,a,M as s,B as o,N as u,b as c,i as l,d as h,G as d,e as f,g as m}from"./xgplayer-streaming-shared-a05e1a43.js";import{W as p,F as v,T as y,a as g,M as _,L as S}from"./xgplayer-transmuxer-2825904a.js";import{B as b,S as k,U as E,D as T,E as x,a as w}from"./xgplayer-ddb6d22b.js";function L(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function A(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?L(Object(r),!0).forEach((function(t){U(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):L(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function D(){D=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n=Object.defineProperty||function(e,t,r){e[t]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",o=i.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(A){u=function(e,t,r){return e[t]=r}}function c(e,t,r,i){var a=t&&t.prototype instanceof d?t:d,s=Object.create(a.prototype),o=new x(i||[]);return n(s,"_invoke",{value:b(e,r,o)}),s}function l(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(A){return{type:"throw",arg:A}}}e.wrap=c;var h={};function d(){}function f(){}function m(){}var p={};u(p,a,(function(){return this}));var v=Object.getPrototypeOf,y=v&&v(v(w([])));y&&y!==t&&r.call(y,a)&&(p=y);var g=m.prototype=d.prototype=Object.create(p);function _(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function S(e,t){function i(n,a,s,o){var u=l(e[n],e,a);if("throw"!==u.type){var c=u.arg,h=c.value;return h&&"object"==typeof h&&r.call(h,"__await")?t.resolve(h.__await).then((function(e){i("next",e,s,o)}),(function(e){i("throw",e,s,o)})):t.resolve(h).then((function(e){c.value=e,s(c)}),(function(e){return i("throw",e,s,o)}))}o(u.arg)}var a;n(this,"_invoke",{value:function(e,r){function n(){return new t((function(t,n){i(e,r,t,n)}))}return a=a?a.then(n,n):n()}})}function b(e,t,r){var n="suspendedStart";return function(i,a){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===i)throw a;return{value:void 0,done:!0}}for(r.method=i,r.arg=a;;){var s=r.delegate;if(s){var o=k(s,r);if(o){if(o===h)continue;return o}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var u=l(e,t,r);if("normal"===u.type){if(n=r.done?"completed":"suspendedYield",u.arg===h)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(n="completed",r.method="throw",r.arg=u.arg)}}}function k(e,t){var r=t.method,n=e.iterator[r];if(void 0===n)return t.delegate=null,"throw"===r&&e.iterator.return&&(t.method="return",t.arg=void 0,k(e,t),"throw"===t.method)||"return"!==r&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+r+"' method")),h;var i=l(n,e.iterator,t.arg);if("throw"===i.type)return t.method="throw",t.arg=i.arg,t.delegate=null,h;var a=i.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,h):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,h)}function E(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function T(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function x(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(E,this),this.reset(!0)}function w(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,i=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return i.next=i}}return{next:L}}function L(){return{value:void 0,done:!0}}return f.prototype=m,n(g,"constructor",{value:m,configurable:!0}),n(m,"constructor",{value:f,configurable:!0}),f.displayName=u(m,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===f||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,u(e,o,"GeneratorFunction")),e.prototype=Object.create(g),e},e.awrap=function(e){return{__await:e}},_(S.prototype),u(S.prototype,s,(function(){return this})),e.AsyncIterator=S,e.async=function(t,r,n,i,a){void 0===a&&(a=Promise);var s=new S(c(t,r,n,i),a);return e.isGeneratorFunction(r)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},_(g),u(g,o,"Generator"),u(g,a,(function(){return this})),u(g,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},e.values=w,x.prototype={constructor:x,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(T),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return s.type="throw",s.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return n("end");if(a.tryLoc<=this.prev){var o=r.call(a,"catchLoc"),u=r.call(a,"finallyLoc");if(o&&u){if(this.prev<a.catchLoc)return n(a.catchLoc,!0);if(this.prev<a.finallyLoc)return n(a.finallyLoc)}else if(o){if(this.prev<a.catchLoc)return n(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return n(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var a=i;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var s=a?a.completion:{};return s.type=e,s.arg=t,a?(this.method="next",this.next=a.finallyLoc,h):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),h},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),T(r),h}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var i=n.arg;T(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:w(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),h}},e}function I(e){return(I="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function O(e,t,r,n,i,a,s){try{var o=e[a](s),u=o.value}catch(c){return void r(c)}o.done?t(u):Promise.resolve(u).then(n,i)}function C(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var a=e.apply(t,r);function s(e){O(a,n,i,s,o,"next",e)}function o(e){O(a,n,i,s,o,"throw",e)}s(void 0)}))}}function P(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function R(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,K(n.key),n)}}function N(e,t,r){return t&&R(e.prototype,t),r&&R(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function U(e,t,r){return(t=K(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function B(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&F(e,t)}function M(e){return(M=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function F(e,t){return(F=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function V(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function j(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=M(e);if(t){var i=M(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return function(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return V(e)}(this,r)}}function G(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,i,a,s,o=[],u=!0,c=!1;try{if(a=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;u=!1}else for(;!(u=(n=a.call(r)).done)&&(o.push(n.value),o.length!==t);u=!0);}catch(l){c=!0,i=l}finally{try{if(!u&&null!=r.return&&(s=r.return(),Object(s)!==s))return}finally{if(c)throw i}}return o}}(e,t)||Y(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function H(e){return function(e){if(Array.isArray(e))return W(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||Y(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Y(e,t){if(e){if("string"==typeof e)return W(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?W(e,t):void 0}}function W(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function K(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}var X=function(){function e(){P(this,e);var t=window.crypto||window.msCrypto;this.subtle=t&&(t.subtle||t.webkitSubtle),this.externalDecryptor=null}var r,n;return N(e,[{key:"destroy",value:function(){var e;null!==(e=this.externalDecryptor)&&void 0!==e&&e.destroy&&this.externalDecryptor.destroy()}},{key:"decrypt",value:function(e,t){if(e||t){var r=[];return e&&(r[0]=this._decryptSegment(e)),t&&(r[1]=this._decryptSegment(t)),Promise.all(r)}}},{key:"_decryptSegment",value:(n=C(D().mark((function e(r){var n;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.data,!r.key){e.next=5;break}return e.next=4,this._decryptData(r.data,r.key,r.keyIv);case 4:n=e.sent;case 5:if(r.map){e.next=7;break}return e.abrupt("return",n);case 7:return e.abrupt("return",t(r.map,n));case 8:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"_decryptData",value:(r=C(D().mark((function e(t,r,n){var i;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.externalDecryptor){e.next=6;break}return e.next=3,this.externalDecryptor.decrypt(t,r,n);case 3:return e.abrupt("return",e.sent);case 6:if(this.subtle){e.next=8;break}throw new Error("crypto is not defined");case 8:return e.next=10,this.subtle.importKey("raw",r,{name:"AES-CBC"},!1,["encrypt","decrypt"]);case 10:return i=e.sent,e.t0=Uint8Array,e.next=14,this.subtle.decrypt({name:"AES-CBC",iv:n},i,t);case 14:return e.t1=e.sent,e.abrupt("return",new e.t0(e.t1));case 16:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return r.apply(this,arguments)})}]),e}(),Q=A(A({},r),{},{STREAM_PARSED:"core.streamparsed",NO_AUDIO_TRACK:"core.noaudiotrack",SUBTITLE_SEGMENTS:"core.subtitlesegments",SUBTITLE_PLAYLIST:"core.subtitleplaylist",SEI_PAYLOAD_TIME:"core.seipayloadtime",APPEND_COST:"core.appendcost"}),$=new n("Transmuxer"),J=function(){function e(t,r,n){P(this,e),U(this,"_initSegmentId",""),this.hls=t,this._demuxer=r?new v:new y,this._isMP4=r,n&&(this._remuxer=new g(this._demuxer.videoTrack,this._demuxer.audioTrack))}return N(e,[{key:"transmux",value:function(e,r,n,s,o,u){var c=this._demuxer;try{this._isMP4?c.demux(e,r):c.demuxAndFix(t(e,r),n,s,o)}catch(b){throw new i(a.DEMUX,a.SUB_TYPES.HLS,b)}var l=c.videoTrack,h=c.audioTrack,d=c.metadataTrack,f="".concat(l.codec,"/").concat(l.width,"/").concat(l.height,"/").concat(h.codec,"/").concat(h.config);if(f!==this._initSegmentId&&(this._initSegmentId=f,u=!0),this._fireEvents(l,h,d,n||u),this.hls.emit(Q.DEMUXED_TRACK,{videoTrack:l,audioTrack:h}),!this._remuxer)return[l,h];try{var m=this._remuxer.remux(u),p=m.videoInitSegment,v=m.videoSegment,y=m.audioInitSegment,g=m.audioSegment,_=t(p,v),S=t(y,g);return[_?{codec:l.codec,data:_}:void 0,S?{codec:h.codec,data:S}:void 0]}catch(b){throw new i(a.REMUX,a.SUB_TYPES.FMP4,b)}}},{key:"_fireEvents",value:function(e,t,r,n){var i=this;$.debug(e.samples,t.samples),n&&(e.exist()&&this.hls.emit(Q.METADATA_PARSED,{type:"video",track:e,meta:{codec:e.codec,timescale:e.timescale,width:e.width,height:e.height,sarRatio:e.sarRatio,baseDts:e.baseDts}}),t.exist()&&this.hls.emit(Q.METADATA_PARSED,{type:"audio",track:t,meta:{codec:t.codec,channelCount:t.channelCount,sampleRate:t.sampleRate,timescale:t.timescale,baseDts:t.baseDts}}),$.debug("discontinuity",e,t)),e.warnings.forEach((function(e){var t;switch(e.type){case p.LARGE_AV_SHIFT:t=Q.LARGE_AV_FIRST_FRAME_GAP_DETECT;break;case p.LARGE_VIDEO_GAP:t=Q.LARGE_VIDEO_DTS_GAP_DETECT;break;case p.LARGE_VIDEO_GAP_BETWEEN_CHUNK:t=Q.MAX_DTS_DELTA_WITH_NEXT_SEGMENT_DETECT}t&&i.hls.emit(Q.STREAM_EXCEPTION,A(A({},e),{},{type:t})),$.warn("video exception",e)})),t.warnings.forEach((function(e){var t;switch(e.type){case p.LARGE_AUDIO_GAP:t=Q.LARGE_AUDIO_DTS_GAP_DETECT;break;case p.AUDIO_FILLED:t=Q.AUDIO_GAP_DETECT;break;case p.AUDIO_DROPPED:t=Q.AUDIO_OVERLAP_DETECT}t&&i.hls.emit(Q.STREAM_EXCEPTION,A(A({},e),{},{type:t})),$.warn("audio exception",e)})),e.samples.forEach((function(e){e.keyframe&&i.hls.emit(Q.KEYFRAME,{pts:e.pts})})),r.seiSamples.forEach((function(e){i.hls.emit(Q.SEI,A(A({},e),{},{originPts:e.originPts/90,sei:{code:e.data.type,content:e.data.payload,dts:e.pts}}))}))}}]),e}(),z=new n("BufferService"),q=function(){function e(t){P(this,e),U(this,"_decryptor",new X),U(this,"_transmuxer",null),U(this,"_mse",null),U(this,"_softVideo",null),U(this,"_sourceCreated",!1),U(this,"_needInitSegment",!0),U(this,"_directAppend",!1),this.hls=t,t.config.softDecode?this._softVideo=t.media:(this._mse=new s,t.config.url&&this._mse.bindMedia(t.media)),t.config.decryptor&&(this._decryptor.externalDecryptor=t.config.decryptor)}var t,n,u,c,l,h,d,f,m;return N(e,[{key:"baseDts",get:function(){var e,t,r;return null===(e=this._transmuxer)||void 0===e||null===(t=e._demuxer)||void 0===t||null===(r=t._fixer)||void 0===r?void 0:r._baseDts}},{key:"nbSb",get:function(){var e;return null!==(e=this._mse)&&void 0!==e&&e._sourceBuffer?Object.keys(this._mse._sourceBuffer).length:0}},{key:"msIsOpend",get:function(){var e;return null===(e=this._mse)||void 0===e?void 0:e.isOpened}},{key:"updateDuration",value:(m=C(D().mark((function e(t){return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(z.debug("update duration",t),!this._mse){e.next=9;break}if(this._mse.isOpened){e.next=5;break}return e.next=5,this._mse.open();case 5:return e.next=7,this._mse.updateDuration(t);case 7:e.next=10;break;case 9:this._softVideo&&(this._softVideo.duration=t);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"createSource",value:function(e,t,r,n){if(!this._sourceCreated){var s=e||t;if(s){if(y.probe(s))this._transmuxer||(this._transmuxer=new J(this.hls,!1,!this._softVideo));else{if(!_.probe(s))throw new i(a.OTHER,null,null,null,"unsupported stream");if(this._softVideo)this._transmuxer||(this._transmuxer=new J(this.hls,!0));else{this._directAppend=!0;var o=!1;e&&!r&&_.findBox(e,["moov","trak"]).forEach((function(e){var t=_.findBox(e.data,["trak","mdia","minf","stbl","stsd"])[0];if(t){var i=_.stsd(t).entries[0];if(i)if(i.hvcC)r=i.hvcC.codec||"hev1.1.6.L93.B0";else if(i.avcC)r=i.avcC.codec;else if(i.sampleRate||i.esds){var a;n=(null===(a=i.esds)||void 0===a?void 0:a.codec)||"mp4a.40.2",o=!0}}})),t&&!n&&_.findBox(t,["moov","trak","mdia","minf","stbl","stsd"]).forEach((function(e){var t=_.stsd(e).entries[0];t&&t.esds&&(n=t.esds.codec)})),e&&!r&&(r="avc1.42e01e"),t&&!n&&(n="mp4a.40.2"),o&&(r+=", ".concat(n),n=""),this._createMseSource(r,n)}}this._softVideo&&(this._sourceCreated=!0)}}}},{key:"appendBuffer",value:(f=C(D().mark((function e(t,r,n,i,a,o,u){var c,l,h,d,f,m,p,v,y;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=n&&n.length||null!=i&&i.length){e.next=2;break}return e.abrupt("return");case 2:if(!this._directAppend){e.next=7;break}return c=[],n&&c.push(this._mse.append(s.VIDEO,n)),i&&c.push(this._mse.append(s.AUDIO,i)),e.abrupt("return",Promise.all(c));case 7:if(l=this._needInitSegment||a,h=this._transmuxer.transmux(n,i,a,o,u,this._needInitSegment||a),d=G(h,2),f=d[0],m=d[1],i&&r&&(null==r||r.setTrackExist(!1,!0)),i&&t&&(null==t||t.setTrackExist(!0,!1)),r||null==t||t.setTrackExist(!!f,!!m),f&&!m&&this.hls.emit(Q.NO_AUDIO_TRACK),!this._softVideo){e.next=18;break}this._softVideo.appendBuffer(f,m),this._needInitSegment=!1,e.next=28;break;case 18:if(!this._mse){e.next=28;break}return(p=!this._sourceCreated)&&this._createMseSource(null==f?void 0:f.codec,null==m?void 0:m.codec),this._needInitSegment=!1,v=this._mse,y=[],l&&!p&&this._handleCodecChange(f,m),f&&y.push(v.append(s.VIDEO,f.data)),m&&y.push(v.append(s.AUDIO,m.data)),e.abrupt("return",Promise.all(y));case 28:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n,i,a,s){return f.apply(this,arguments)})},{key:"removeBuffer",value:(d=C(D().mark((function e(){var t,n,i,a=this,s=arguments;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=s.length>0&&void 0!==s[0]?s[0]:0,n=s.length>1&&void 0!==s[1]?s[1]:1/0,i=this.hls.media,!(!this._mse||!i||t<0||n<t||t>=this._mse.duration)){e.next=5;break}return e.abrupt("return");case 5:return e.abrupt("return",this._mse.clearBuffer(t,n).then((function(){return a.hls.emit(r.REMOVE_BUFFER,{start:t,end:n,removeEnd:n})})));case 6:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"evictBuffer",value:(h=C(D().mark((function e(t){var r,n,i;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.hls.media,this._mse&&r&&t&&!(t<0)){e.next=3;break}return e.abrupt("return");case 3:if(n=r.currentTime,!((i=n-t)<=0)){e.next=7;break}return e.abrupt("return");case 7:if(!(o.start(o.get(r))+1>=i)){e.next=10;break}return e.abrupt("return");case 10:return e.abrupt("return",this.removeBuffer(0,i));case 11:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"clearAllBuffer",value:(l=C(D().mark((function e(){return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._mse){e.next=2;break}return e.abrupt("return",this._mse.clearAllBuffer());case 2:case"end":return e.stop()}}),e,this)}))),function(){return l.apply(this,arguments)})},{key:"decryptBuffer",value:function(e,t){return this._decryptor.decrypt(e,t)}},{key:"reset",value:(c=C(D().mark((function e(){var t,r=arguments;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r.length>0&&void 0!==r[0]&&r[0],!this._mse||t){e.next=8;break}return this._transmuxer=null,this._sourceCreated=!1,e.next=6,this._mse.unbindMedia();case 6:return e.next=8,this._mse.bindMedia(this.hls.media);case 8:this._needInitSegment=!0,this._directAppend=!1;case 10:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"endOfStream",value:(u=C(D().mark((function e(){return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._mse){e.next=5;break}if(!this._sourceCreated){e.next=5;break}return e.next=4,this._mse.endOfStream();case 4:this.hls.emit(r.BUFFEREOS);case 5:this._softVideo&&this._softVideo.endOfStream();case 6:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"setLiveSeekableRange",value:(n=C(D().mark((function e(t,r){return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this._mse&&this._mse.setLiveSeekableRange(t,r);case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"destroy",value:(t=C(D().mark((function e(){var t;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null===(t=this._decryptor)||void 0===t||t.destroy(),!this._mse){e.next=4;break}return e.next=4,this._mse.unbindMedia();case 4:this._decryptor=null,this._mse=null,this._softVideo=null;case 7:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"_createMseSource",value:function(e,t){z.debug("create mse source, videoCodec=".concat(e,", audioCodec=").concat(t));var n=this._mse;n&&(e&&(n.createSource(s.VIDEO,"video/mp4;codecs=".concat(e)),this._sourceCreated=!0),t&&(n.createSource(s.AUDIO,"audio/mp4;codecs=".concat(t)),this._sourceCreated=!0),this.hls.emit(r.SOURCEBUFFER_CREATED))}},{key:"_handleCodecChange",value:function(e,t){var r=this._mse;[{type:s.VIDEO,codecs:null==e?void 0:e.codec},{type:s.AUDIO,codecs:null==t?void 0:t.codec}].filter((function(e){return!!e.codecs})).forEach((function(e){var t=e.type,n=e.codecs,i=r.getSourceBuffer(t);if(i){var a=n.split(",")[0];new RegExp(a,"ig").test(i.mimeType)||r.changeType(t,"".concat(t,"/mp4;codecs=").concat(n))}}))}},{key:"seamlessSwitch",value:function(){this._needInitSegment=!0}},{key:"isFull",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:s.VIDEO;return null===(e=this._mse)||void 0===e?void 0:e.isFull(t)}}]),e}();var Z=N((function e(){P(this,e),U(this,"version",0),U(this,"streams",[]),U(this,"isMaster",!0)})),ee="AUDIO",te="SUBTITLE",re=N((function e(){P(this,e),U(this,"id",0),U(this,"url",""),U(this,"default",!1),U(this,"autoSelect",!1),U(this,"forced",!1),U(this,"group",""),U(this,"name",""),U(this,"lang",""),U(this,"segments",[]),U(this,"endSN",0)})),ne=function(e){B(r,re);var t=j(r);function r(){var e;P(this,r);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return U(V(e=t.call.apply(t,[this].concat(i))),"mediaType",ee),U(V(e),"channels",0),e}return N(r)}(),ie=function(e){B(r,re);var t=j(r);function r(){var e;P(this,r);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return U(V(e=t.call.apply(t,[this].concat(i))),"mediaType",te),e}return N(r)}(),ae=N((function e(){P(this,e),U(this,"id",0),U(this,"bitrate",0),U(this,"width",0),U(this,"height",0),U(this,"name",""),U(this,"url",""),U(this,"audioCodec",""),U(this,"videoCodec",""),U(this,"textCodec",""),U(this,"audioGroup",""),U(this,"audioStreams",[]),U(this,"subtitleStreams",[]),U(this,"closedCaptionsStream",[])})),se=N((function e(){P(this,e),U(this,"version",0),U(this,"url",""),U(this,"type",""),U(this,"startCC",0),U(this,"endCC",0),U(this,"startSN",0),U(this,"endSN",0),U(this,"totalDuration",0),U(this,"targetDuration",0),U(this,"partTargetDuration",0),U(this,"canSkipUntil",0),U(this,"canSkipDateRanges",!1),U(this,"skippedSegments",0),U(this,"canBlockReload",!1),U(this,"partHoldBack",0),U(this,"live",!0),U(this,"lowLatency",!1),U(this,"endPartIndex",0),U(this,"segments",[])})),oe=function(){function e(){P(this,e),U(this,"sn",0),U(this,"cc",0),U(this,"url",""),U(this,"title",""),U(this,"start",0),U(this,"duration",0),U(this,"dataTime",""),U(this,"key",null),U(this,"byteRange",null),U(this,"isInitSegment",!1),U(this,"initSegment",null),U(this,"isLast",!1),U(this,"hasAudio",!1),U(this,"hasVideo",!1),U(this,"independent",!1),U(this,"partIndex",0)}return N(e,[{key:"end",get:function(){return this.start+this.duration}},{key:"setTrackExist",value:function(e,t){this.hasVideo=e,this.hasAudio=t}},{key:"setByteRange",value:function(e,t){this.byteRange=[0];var r=e.split("@");1===r.length&&t&&t.byteRange?(this.byteRange[0]=t.byteRange[1]||0,this.byteRange[0]&&(this.byteRange[0]+=1)):this.byteRange[0]=parseInt(r[1]),this.byteRange[1]=this.byteRange[0]+parseInt(r[0])-1}}]),e}(),ue=function(){function e(t){P(this,e),U(this,"method",""),U(this,"url",""),U(this,"iv",null),U(this,"keyFormat",""),U(this,"keyFormatVersions",""),t instanceof e&&(this.method=t.method,this.url=t.url,this.keyFormat=t.keyFormat,this.keyFormatVersions=t.keyFormatVersions,t.iv&&(this.iv=new Uint8Array(t.iv)))}return N(e,[{key:"clone",value:function(t){var r=new e(this);return null!=t&&r.setIVFromSN(t),r}},{key:"setIVFromSN",value:function(e){if(!this.iv&&"AES-128"===this.method&&"number"==typeof e&&this.url){this.iv=new Uint8Array(16);for(var t=12;t<16;t++)this.iv[t]=e>>8*(15-t)&255}}}]),e}(),ce=/^#(EXT[^:]*)(?::(.*))?$/,le=/([^=]+)=(?:"([^"]*)"|([^",]*))(?:,|$)/g,he=/^(?:[a-zA-Z0-9+\-.]+:)?\/\//,de=/^((?:[a-zA-Z0-9+\-.]+:)?\/\/[^/?#]*)?([^?#]*\/)?/;function fe(e){var t=e.match(ce);if(t&&t[1])return[t[1].replace("EXT-X-",""),t[2]]}function me(e){for(var t={},r=le.exec(e);r;)t[r[1]]=r[2]||r[3],r=le.exec(e);return t}function pe(e,t){if(!t||!e||he.test(e))return e;var r=de.exec(t);return r?"/"===e[0]?r[1]+e:r[1]+r[2]+e:e}var ve={audio:[/^mp4a/,/^vorbis$/,/^opus$/,/^flac$/,/^[ae]c-3$/],video:[/^avc/,/^hev/,/^hvc/,/^vp0?[89]/,/^av1$/],text:[/^vtt$/,/^wvtt/,/^stpp/]};function ye(e,t){var r=ve[e];if(r&&t&&t.length)for(var n=0;n<r.length;n++)for(var i=0;i<t.length;i++)if(r[n].test(t[i]))return t[i]}var ge=function(){function e(){P(this,e)}return N(e,null,[{key:"parse",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",r=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0;if(!t.includes("#EXTM3U"))throw new Error("Invalid m3u8 file");var i=function(e){return e.split(/[\r\n]/).map((function(e){return e.trim()})).filter(Boolean)}(t);return e.isMediaPlaylist(t)?function(e,t,r){var n=new se;n.url=t;for(var i,a=new oe,s=null,o=null,u=0,c=0,l=0,h=0,d=!1,f=0;(i=e[h++])&&!d;)if("#"===i[0]){var m=fe(i);if(m){var p=G(m,2),v=p[0],y=p[1];switch(v){case"VERSION":n.version=parseInt(y);break;case"PLAYLIST-TYPE":n.type=null==y?void 0:y.toUpperCase();break;case"TARGETDURATION":n.targetDuration=parseFloat(y);break;case"PART-INF":r&&(n.lowLatency=!0);var g=me(y);g["PART-TARGET"]&&(n.partTargetDuration=parseFloat(g["PART-TARGET"]));break;case"SERVER-CONTROL":var _=me(y);n.canBlockReload="YES"===_["CAN-BLOCK-RELOAD"],n.partHoldBack=parseFloat(_["PART-HOLD-BACK"]||0),n.canSkipUntil=parseFloat(_["CAN-SKIP-UNTIL"]||0),n.canSkipDateRanges="YES"===_["CAN-SKIP-DATERANGES"];break;case"ENDLIST":var S=n.segments[n.segments.length-1];S&&(S.isLast=!0),n.live=!1,d=!0;break;case"MEDIA-SEQUENCE":c=n.startSN=parseInt(y);break;case"DISCONTINUITY-SEQUENCE":l=n.startCC=parseInt(y);break;case"DISCONTINUITY":l++;break;case"BYTERANGE":a.setByteRange(y,n.segments[n.segments.length-1]);break;case"PART":if(!n.lowLatency)break;var b=me(y);a.duration=parseFloat(b.DURATION),a.independent="YES"===b.INDEPENDENT,a.sn=c,a.cc=l,a.partIndex=f,a.start=u,a.duration=parseFloat(b.DURATION),u+=a.duration,a.url=pe(b.URI,t),o&&(a.key=o.clone(c)),s&&(a.initSegment=s),n.segments.push(a),a=new oe,f++;break;case"PRELOAD-HINT":break;case"PROGRAM-DATE-TIME":a.dataTime=y;break;case"EXTINF":if(n.lowLatency){f=0;break}var k=G(y.split(","),2),E=k[0],T=k[1];a.start=u,a.duration=parseFloat(E),u+=a.duration,a.title=T;break;case"KEY":var x=me(y);if("NONE"===x.METHOD){o=null;break}if("AES-128"!==x.METHOD)throw new Error("encrypt ".concat(x.METHOD,"/").concat(x.KEYFORMAT," is not supported"));if((o=new ue).method=x.METHOD,o.url=/^blob:/.test(x.URI)?x.URI:pe(x.URI,t),o.keyFormat=x.KEYFORMAT||"identity",o.keyFormatVersions=x.KEYFORMATVERSIONS,x.IV){var w=x.IV.slice(2);w=(1&w.length?"0":"")+w,o.iv=new Uint8Array(w.length/2);for(var L=0,A=w.length/2;L<A;L++)o.iv[L]=parseInt(w.slice(2*L,2*L+2),16)}break;case"MAP":var D=me(y);a.url=pe(D.URI,t),D.BYTERANGE&&a.setByteRange(D.BYTERANGE),a.isInitSegment=!0,a.sn=0,o&&(a.key=o.clone(0)),s=a,a=new oe}}}else{if(n.lowLatency){c++;continue}a.sn=c,a.cc=l,a.url=pe(i,t),o&&(a.key=o.clone(c)),s&&(a.initSegment=s),n.segments.push(a),a=new oe,c++}n.segments=n.segments.filter((function(e){return 0!==e.duration}));var I=n.segments[n.segments.length-1];return I&&(n.endSN=I.sn,n.endPartIndex=I.partIndex),n.totalDuration=u,n.endCC=l,n}(i,r,n):function(e,t){for(var r,n=new Z,i=0,a=[],s=[];r=e[i++];){var o=fe(r);if(o){var u=G(o,2),c=u[0],l=u[1];if("VERSION"===c)n.version=parseInt(l);else if("MEDIA"===c&&l){var h=me(l),d=void 0;switch(h.TYPE){case"AUDIO":d=new ne;break;case"SUBTITLES":d=new ie;break;default:d=new re}d.url=pe(h.URI,t),d.default="YES"===h.DEFAULT,d.autoSelect="YES"===h.AUTOSELECT,d.group=h["GROUP-ID"],d.name=h.NAME,d.lang=h.LANGUAGE,h.CHANNELS&&(d.channels=Number(h.CHANNELS.split("/")[0]),Number.isNaN(d.channels)&&(d.channels=0)),"AUDIO"===h.TYPE&&h.URI&&a.push(d),"SUBTITLES"===h.TYPE&&s.push(d)}else if("STREAM-INF"===c&&l){var f=new ae,m=me(l);if(f.bitrate=parseInt(m["AVERAGE-BANDWIDTH"]||m.BANDWIDTH),f.name=m.NAME,f.url=pe(e[i++],t),m.RESOLUTION){var p=G(m.RESOLUTION.split("x"),2),v=p[0],y=p[1];f.width=parseInt(v),f.height=parseInt(y)}if(m.CODECS){var g=m.CODECS.split(/[ ,]+/).filter(Boolean);f.videoCodec=ye("video",g),f.audioCodec=ye("audio",g),f.textCodec=ye("text",g)}f.audioGroup=m.AUDIO,f.subtitleGroup=m.SUBTITLES,n.streams.push(f)}}}return n.streams.forEach((function(e,t){e.id=t})),a.length&&(a.forEach((function(e,t){e.id=t})),n.streams.forEach((function(e){e.audioGroup&&(e.audioStreams=a.filter((function(t){return t.group===e.audioGroup})))}))),s.length&&(s.forEach((function(e,t){e.id=t})),n.streams.forEach((function(e){e.subtitleGroup&&(e.subtitleStreams=s.filter((function(t){return t.group===e.subtitleGroup})))}))),n}(i,r)}},{key:"isMediaPlaylist",value:function(e){return e.includes("#EXTINF:")||e.includes("#EXT-X-TARGETDURATION:")}}]),e}(),_e=function(){function e(t){var n=this;P(this,e),U(this,"_emitOnLoaded",(function(e,t){var i=e.response,a=e.options||{},s=a.firstByteTime,o=a.startTime,u=a.endTime,c=a.contentLength,l=u-o;n.hls.emit(r.SPEED,{time:l,byteLength:c,url:t}),n.hls.emit(r.LOAD_COMPLETE,{url:t,elapsed:l||0}),n.hls.emit(r.TTFB,{url:t,responseUrl:i.url,elapsed:s-o}),n.hls.emit(r.LOAD_RESPONSE_HEADERS,{headers:i.headers,url:t})})),U(this,"_onLoaderRetry",(function(e,t){n.hls.emit(Q.LOAD_RETRY,{error:i.network(e),retryTime:t})})),this.hls=t,this._timer=null,this._useLowLatency=t.config.useLowLatency;var a=this.hls.config,s=a.retryCount,o=a.retryDelay,c=a.manifestLoadTimeout,l=a.fetchOptions;this._loader=new u(A(A({},l),{},{responseType:"text",retry:s,retryDelay:o,timeout:c,onRetryError:this._onLoaderRetry})),this._audioLoader=new u(A(A({},l),{},{responseType:"text",retry:s,retryDelay:o,timeout:c,onRetryError:this._onLoaderRetry})),this._subtitleLoader=new u(A(A({},l),{},{responseType:"text",retry:s,retryDelay:o,timeout:c,onRetryError:this._onLoaderRetry}))}var t;return N(e,[{key:"load",value:(t=C(D().mark((function e(t,r,n){var s,o,u,c,l,h,d,f,m,p,v,y,g,_,S,b,k,E,T,x;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=[this._loader.load(t)],r&&s.push(this._audioLoader.load(r)),n&&s.push(this._subtitleLoader.load(n)),e.prev=3,e.next=6,Promise.all(s);case 6:if(f=e.sent,m=G(f,3),p=m[0],v=m[1],y=m[2],p){e.next=13;break}return e.abrupt("return",[]);case 13:this._emitOnLoaded(p,t),o=p.data,l=p.response.url||t,r?(u=null==v?void 0:v.data,c=null==y?void 0:y.data,h=(null==v||null===(g=v.response)||void 0===g?void 0:g.url)||r,d=(null==y||null===(_=y.response)||void 0===_?void 0:_.url)||n,u&&this._emitOnLoaded(v,r),c&&this._emitOnLoaded(y,n)):(c=null==v?void 0:v.data,d=(null==v||null===(S=v.response)||void 0===S?void 0:S.url)||n,c&&this._emitOnLoaded(v,n)),e.next=22;break;case 19:throw e.prev=19,e.t0=e.catch(3),i.network(e.t0);case 22:if(b=this.hls.config.onPreM3U8Parse,e.prev=23,b&&(o=b(o)||o,u&&(u=b(u,!0)||u),c&&(c=b(c,!0)||c)),k=ge.parse(o,l,this._useLowLatency),!1!==(null===(x=k)||void 0===x?void 0:x.live)||!k.segments||k.segments.length){e.next=28;break}throw new Error("empty segments list");case 28:u&&(E=ge.parse(u,h,this._useLowLatency)),c&&(T=ge.parse(c,d,this._useLowLatency)),e.next=35;break;case 32:throw e.prev=32,e.t1=e.catch(23),new i(a.MANIFEST,a.SUB_TYPES.HLS,e.t1);case 35:return k&&(k.isMaster?this.hls.emit(Q.HLS_MANIFEST_LOADED,{playlist:k}):this.hls.emit(Q.HLS_LEVEL_LOADED,{playlist:k})),e.abrupt("return",[k,E,T]);case 37:case"end":return e.stop()}}),e,this,[[3,19],[23,32]])}))),function(e,r,n){return t.apply(this,arguments)})},{key:"parseText",value:function(e,t){var r,n=this.hls.config.onPreM3U8Parse;try{var s;if(n&&(e=n(e)||e),!1===(null===(s=r=ge.parse(e,t,this._useLowLatency))||void 0===s?void 0:s.live)&&r.segments&&!r.segments.length)throw new Error("empty segments list")}catch(o){throw new i(a.MANIFEST,a.SUB_TYPES.HLS,o)}return r&&(r.isMaster?this.hls.emit(Q.HLS_MANIFEST_LOADED,{playlist:r}):this.hls.emit(Q.HLS_LEVEL_LOADED,{playlist:r})),[r]}},{key:"poll",value:function(e,t,r,n,i,a){var s=this;clearTimeout(this._timer),a=a||3e3;var o=this.hls.config.pollRetryCount,u=function(){var c=C(D().mark((function c(){var l;return D().wrap((function(c){for(;;)switch(c.prev=c.next){case 0:return clearTimeout(s._timer),c.prev=1,c.next=4,s.load(e,t,r);case 4:if((l=c.sent)[0]){c.next=7;break}return c.abrupt("return");case 7:o=s.hls.config.pollRetryCount,n(l[0],l[1],l[2]),c.next=15;break;case 11:c.prev=11,c.t0=c.catch(1),--o<=0&&i(c.t0);case 15:s._timer=setTimeout(u,a);case 16:case"end":return c.stop()}}),c,null,[[1,11]])})));return function(){return c.apply(this,arguments)}}();this._timer=setTimeout(u,a)}},{key:"stopPoll",value:function(){return clearTimeout(this._timer),this.cancel()}},{key:"cancel",value:function(){return Promise.all([this._loader.cancel(),this._audioLoader.cancel()])}}]),e}();function Se(e,t,r){return t>r&&(r=t),Math.min(Math.max(e,t),r)}var be=new n("playlist"),ke=function(){function e(t,r,n){P(this,e),U(this,"live",void 0),U(this,"id",0),U(this,"bitrate",0),U(this,"width",0),U(this,"height",0),U(this,"name",""),U(this,"url",""),U(this,"audioCodec",""),U(this,"videoCodec",""),U(this,"textCodec",""),U(this,"startCC",0),U(this,"endCC",0),U(this,"startSN",0),U(this,"endSN",-1),U(this,"totalDuration",0),U(this,"targetDuration",0),U(this,"partTargetDuration",0),U(this,"canSkipUntil",0),U(this,"canSkipDateRanges",!1),U(this,"skippedSegments",0),U(this,"canBlockReload",!1),U(this,"partHoldBack",0),U(this,"lowLatency",!1),U(this,"endPartIndex",0),U(this,"snDiff",null),U(this,"segments",[]),U(this,"audioStreams",[]),U(this,"subtitleStreams",[]),U(this,"closedCaptions",[]),U(this,"currentAudioStream",null),U(this,"currentSubtitleStream",null),this.update(this._setLLPlaybackPoint(t),r,n)}return N(e,[{key:"lastSegment",get:function(){return this.segments.length?this.segments[this.segments.length-1]:null}},{key:"segmentDuration",get:function(){var e;return this.targetDuration||(null===(e=this.segments[0])||void 0===e?void 0:e.duration)||0}},{key:"liveEdge",get:function(){return this.endTime}},{key:"endTime",get:function(){var e;return(null===(e=this.lastSegment)||void 0===e?void 0:e.end)||0}},{key:"currentSubtitleEndSn",get:function(){var e;return(null===(e=this.currentSubtitleStream)||void 0===e?void 0:e.endSN)||0}},{key:"clearOldSegment",value:function(e,t){return this.currentAudioStream&&this._clearSegments(e,t),this._clearSegments(e,t)}},{key:"getAudioSegment",value:function(e){if(e&&this.currentAudioStream){var t=e.sn-this.snDiff;return this.currentAudioStream.segments.find((function(e){return e.sn===t}))}}},{key:"update",value:function(e,t){this.url=e.url,Array.isArray(e.segments)?(null!==this.live&&void 0!==this.live||(this.live=e.live),this._updateSegments(e,this),this.startCC=e.startCC,this.endCC=e.endCC,this.startSN=e.startSN,this.endSN=e.endSN||-1,this.totalDuration=e.totalDuration,this.targetDuration=e.targetDuration,this.live=e.live,this.lowLatency=e.lowLatency,this.canBlockReload=e.canBlockReload,this.canSkipDateRanges=e.canSkipDateRanges,this.canSkipUntil=e.canSkipUntil,this.partHoldBack=e.partHoldBack,this.partTargetDuration=e.partTargetDuration,this.skippedSegments=e.skippedSegments,this.endPartIndex=e.endPartIndex,t&&this.currentAudioStream&&Array.isArray(t.segments)&&(this._updateSegments(t,this.currentAudioStream),(null===this.snDiff||void 0===this.snDiff)&&e.segments.length&&t.segments.length&&(this.snDiff=e.segments[0].sn-t.segments[0].sn))):(this.id=e.id,this.bitrate=e.bitrate,this.width=e.width,this.height=e.height,this.name=e.name,this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.textCodec=e.textCodec,this.audioStreams=e.audioStreams,this.subtitleStreams=e.subtitleStreams,!this.currentAudioStream&&this.audioStreams.length&&(this.currentAudioStream=this.audioStreams.find((function(e){return e.default}))||this.audioStreams[0]),!this.currentSubtitleStream&&this.subtitleStreams.length&&(this.currentSubtitleStream=this.subtitleStreams.find((function(e){return e.default}))||this.subtitleStreams[0]))}},{key:"updateSubtitle",value:function(e){var t=this;if(e&&this.currentSubtitleStream&&Array.isArray(e.segments)){var r=this._updateSegments(e,this.currentSubtitleStream),n=this.currentSubtitleStream.segments;if(n.length>100&&(this.currentSubtitleStream.segments=n.slice(100)),r)return r.map((function(e){return{sn:e.sn,url:e.url,duration:e.duration,start:e.start,end:e.end,lang:t.currentSubtitleStream.lang}}))}}},{key:"switchSubtitle",value:function(e){var t=this.subtitleStreams.find((function(t){return t.lang===e})),r=this.currentSubtitleStream;t&&(this.currentSubtitleStream=t,r.segments=[])}},{key:"_setLLPlaybackPoint",value:function(e){if(!e.lowLatency||!e.segments.length)return e;for(var t=e.totalDuration-e.partHoldBack,r=e.segments,n=0,i=0,a=r.length;i<a;i++)r[i].start<=t&&r[i].independent&&(n=i);var s=r.slice(n),o=0;return s.forEach((function(e){e.start=o,o=e.end})),e.segments=s,e.totalDuration=o,e.startSN=s[0].sn,e.startCC=s[0].cc,be.log("set ll-hls playback point: SN=".concat(e.startSN," partIndex=").concat(s[0].partIndex,", duration=").concat(o)),e}},{key:"_clearSegments",value:function(e,t){for(var r=0,n=this.segments,i=0,a=n.length;i<a;i++)if(n[i].end>=e){r=i;break}return r>t&&(r=t),r&&(this.segments=this.segments.slice(r),this.currentAudioStream&&(this.currentAudioStream.segments=this.currentAudioStream.segments.slice(r))),t-r}},{key:"_updateSegments",value:function(e,t){var r=t.segments;if(this.live){var n=e.lowLatency,i=r[r.length-1],a=(null==i?void 0:i.sn)||-1,s=(null==i?void 0:i.partIndex)||0,o=a<e.endSN&&e.segments.length;if(n&&(o=o||s<e.endPartIndex),o){be.log("update segments: endSN:".concat(a,", partIndex:").concat(s," --\x3e endSN:").concat(e.endSN,", partIndex:").concat(e.endPartIndex));var u=e.segments.findIndex((function(e){return e.sn===a&&e.partIndex===s})),c=u<0?e.segments:e.segments.slice(u+1);if(r.length&&c.length){var l=i.end,h=l;c.forEach((function(e){e.start=l,l=e.end})),be.log("liveEdge: ".concat(h," -> ").concat(l));var d=(null==i?void 0:i.cc)||-1;d>c[0].cc&&c.forEach((function(e){return e.cc+=d}))}return t.endSN=e.endSN,t.segments=r.concat(c),c}}else t.segments=e.segments}}]),e}(),Ee=function(){function e(t){P(this,e),U(this,"streams",[]),U(this,"currentStream",null),U(this,"dvrWindow",0),U(this,"_segmentPointer",-1),this.hls=t}return N(e,[{key:"lowLatency",get:function(){var e;return null===(e=this.currentStream)||void 0===e?void 0:e.lowLatency}},{key:"lastSegment",get:function(){var e;return null===(e=this.currentStream)||void 0===e?void 0:e.lastSegment}},{key:"currentSegment",get:function(){var e;return null===(e=this.currentSegments)||void 0===e?void 0:e[this._segmentPointer]}},{key:"nextSegment",get:function(){var e;return null===(e=this.currentSegments)||void 0===e?void 0:e[this._segmentPointer+1]}},{key:"currentSegments",get:function(){var e;return null===(e=this.currentStream)||void 0===e?void 0:e.segments}},{key:"currentSubtitleEndSn",get:function(){var e;return null===(e=this.currentStream)||void 0===e?void 0:e.currentSubtitleEndSn}},{key:"liveEdge",get:function(){var e;return null===(e=this.currentStream)||void 0===e?void 0:e.liveEdge}},{key:"totalDuration",get:function(){var e;return(null===(e=this.currentStream)||void 0===e?void 0:e.totalDuration)||0}},{key:"seekRange",get:function(){var e=this.currentSegments;if(e&&e.length)return[e[0].start,e[e.length-1].end]}},{key:"nbSegments",get:function(){var e;return(null===(e=this.currentSegments)||void 0===e?void 0:e.length)||0}},{key:"isEmpty",get:function(){var e;return!(null!==(e=this.currentSegments)&&void 0!==e&&e.length)}},{key:"isLive",get:function(){var e;return null===(e=this.currentStream)||void 0===e?void 0:e.live}},{key:"hadSegmentLoaded",get:function(){return-1!==this._segmentPointer}},{key:"hasSubtitle",get:function(){var e;return!(null===(e=this.currentStream)||void 0===e||!e.currentSubtitleStream)}},{key:"getAudioSegment",value:function(e){var t;return null===(t=this.currentStream)||void 0===t?void 0:t.getAudioSegment(e)}},{key:"moveSegmentPointer",value:function(e){var t;null==e&&(e=this._segmentPointer+1),this._segmentPointer=Se(e,-1,null===(t=this.currentSegments)||void 0===t?void 0:t.length)}},{key:"reset",value:function(){this.streams=[],this.currentStream=null,this.dvrWindow=0,this._segmentPointer=-1}},{key:"getSegmentByIndex",value:function(e){var t;return null===(t=this.currentSegments)||void 0===t?void 0:t[e]}},{key:"setNextSegmentByIndex",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this._segmentPointer=e-1}},{key:"findSegmentIndexByTime",value:function(e){var t=this.currentSegments;if(t){for(var r,n=0,i=t.length;n<i;n++)if(e>=(r=t[n]).start&&e<r.end)return n;var a=t[t.length-1];if(Math.abs(e-(null==a?void 0:a.end))<.2)return t.length-1}}},{key:"upsertPlaylist",value:function(e,t,r){var n=this;if(e){if(e.isMaster)this.streams.length=e.streams.length,e.streams.filter((function(e){return e.url})).forEach((function(e,t){n.streams[t]?n.streams[t].update(e):n.streams[t]=new ke(e)})),this.currentStream=this.streams[0];else if(Array.isArray(e.segments)){var i=this.currentStream;if(i){i.update(e,t,r);var a=i.updateSubtitle(r);a&&this.hls.emit(Q.SUBTITLE_SEGMENTS,{list:a})}else this.reset(),this.currentStream=this.streams[0]=new ke(e,t,r)}this.currentStream&&this.hls.isLive&&!this.dvrWindow&&(this.dvrWindow=this.currentSegments.reduce((function(e,t){return e+=t.duration}),0))}}},{key:"switchSubtitle",value:function(e){var t;null===(t=this.currentStream)||void 0===t||t.switchSubtitle(e)}},{key:"clearOldSegment",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:50,t=this.currentStream;if(this.dvrWindow&&t){var r=t.endTime-this.dvrWindow;if(!(r<=0))t.segments.length<=e||(this._segmentPointer=t.clearOldSegment(r,this._segmentPointer))}}},{key:"checkSegmentTrackChange",value:function(e,t){var r=this.findSegmentIndexByTime(e),n=this.getSegmentByIndex(r);if(n&&(n.hasAudio||n.hasVideo)){if(2!==t&&n.hasAudio&&n.hasVideo)return n;if(!(n.end-e>.3)){var i=this.getSegmentByIndex(r+1);if(i&&(i.hasAudio||i.hasVideo))return i.hasAudio!==n.hasAudio||i.hasVideo!==n.hasVideo?i:void 0}}}}]),e}(),Te=function(){function e(t){var n=this;P(this,e),U(this,"error",null),U(this,"_emitOnLoaded",(function(e,t){var i=e.data,a=e.response,s=e.options||{},o=s.firstByteTime,u=s.startTime,c=s.endTime,l=s.contentLength,h=c-u;n._bandwidthService.addRecord(l||i.byteLength,h),n.hls.emit(r.SPEED,{time:h,byteLength:l,url:t}),n.hls.emit(r.LOAD_COMPLETE,{url:t,elapsed:h||0}),n.hls.emit(r.TTFB,{url:t,responseUrl:a.url,elapsed:o-u}),n.hls.emit(r.LOAD_RESPONSE_HEADERS,{headers:a.headers,url:t})})),U(this,"_onLoaderRetry",(function(e,t){n.hls.emit(r.LOAD_RETRY,{error:i.network(e),retryTime:t})})),this.hls=t,this._bandwidthService=new c,this._mapCache={},this._keyCache={};var a=this.hls.config,s=a.retryCount,o=a.retryDelay,l=a.loadTimeout,h=a.fetchOptions;this._segmentLoader=new u(A(A({},h),{},{responseType:"arraybuffer",retry:s,retryDelay:o,timeout:l,onRetryError:this._onLoaderRetry})),this._audioSegmentLoader=new u(A(A({},h),{},{responseType:"arraybuffer",retry:s,retryDelay:o,timeout:l,onRetryError:this._onLoaderRetry})),this._keyLoader=new u(A(A({},h),{},{responseType:"arraybuffer",retry:s,retryDelay:o,timeout:l,onRetryError:this._onLoaderRetry}))}var t,n;return N(e,[{key:"speedInfo",value:function(){return{speed:this._bandwidthService.getLatestSpeed(),avgSpeed:this._bandwidthService.getAvgSpeed()}}},{key:"load",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:r,i=[];return e&&(i[0]=this.loadVideoSegment(e,r)),t&&(i[1]=this.loadAudioSegment(t,n)),Promise.all(i)}},{key:"loadVideoSegment",value:function(e,t){return this._loadSegment(this._segmentLoader,e,t)}},{key:"loadAudioSegment",value:function(e,t){return this._loadSegment(this._audioSegmentLoader,e,t)}},{key:"_loadSegment",value:(n=C(D().mark((function e(t,n,i){var a,s,o,u,c,l,h,d,f,m,p,v,y,g,_,S=this;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return h=[],this.hls.emit(r.LOAD_START,{url:n.url}),h[0]=t.load(n.url),i&&n.initSegment&&(f=n.initSegment.url,(s=this._mapCache[f])||(this.hls.emit(r.LOAD_START,{url:f}),h[1]=t.load(f).then((function(e){e&&(Object.keys(S._mapCache)>30&&(S._mapCache={}),s=S._mapCache[f]=e.data,S._emitOnLoaded(e,f))}))),(m=null===(d=n.initSegment.key)||void 0===d?void 0:d.url)&&(l=n.initSegment.key.iv,(c=this._keyCache[m])||(this.hls.emit(r.LOAD_START,{url:m}),h[2]=this._keyLoader.load(m).then((function(e){e&&(c=S._keyCache[m]=e.data,S._emitOnLoaded(e,m))}))))),(p=null===(a=n.key)||void 0===a?void 0:a.url)&&(u=n.key.iv,(o=this._keyCache[p])||(this.hls.emit(r.LOAD_START,{url:p}),h[3]=this._keyLoader.load(p).then((function(e){e&&(o=S._keyCache[p]=e.data,S._emitOnLoaded(e,p))})))),e.next=8,Promise.all(h);case 8:if(v=e.sent,y=G(v,1),g=y[0]){e.next=13;break}return e.abrupt("return");case 13:return _=g.data,this._emitOnLoaded(g,n.url),e.abrupt("return",{data:_,map:s,key:o,mapKey:c,keyIv:u,mapKeyIv:l});case 16:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return n.apply(this,arguments)})},{key:"reset",value:function(){this.error=null,this._mapCache={},this._keyCache={},this._bandwidthService.reset()}},{key:"cancel",value:(t=C(D().mark((function e(){return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([this._keyLoader.cancel(),this._segmentLoader.cancel(),this._audioSegmentLoader.cancel()]);case 2:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}]),e}(),xe=new n("hls"),we=function(t){B(O,e);var r,u,c,p,v,y,g,_,b,k,E,T,x,w,L=j(O);function O(e){var t,r,n;return P(this,O),U(V(t=L.call(this)),"version",O.version),U(V(t),"media",null),U(V(t),"config",null),U(V(t),"_manifestLoader",null),U(V(t),"_segmentLoader",null),U(V(t),"_playlist",null),U(V(t),"_bufferService",null),U(V(t),"_gapService",null),U(V(t),"_seiService",null),U(V(t),"_stats",null),U(V(t),"_prevSegSn",null),U(V(t),"_prevSegCc",null),U(V(t),"_tickTimer",null),U(V(t),"_tickInterval",500),U(V(t),"_segmentProcessing",!1),U(V(t),"_reloadOnPlay",!1),U(V(t),"_switchUrlOpts",null),U(V(t),"_isProcessQuotaExceeded",!1),U(V(t),"_loadSegment",C(D().mark((function e(){var r,n,i;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t._segmentProcessing&&t.media){e.next=2;break}return e.abrupt("return");case 2:if(r=t._playlist.nextSegment){e.next=5;break}return e.abrupt("return");case 5:if(t.isLive){e.next=13;break}if(n=t.bufferInfo(),t.media.paused&&!t.media.currentTime&&(n=t.bufferInfo(n.nextStart||.5)),i=Math.abs(n.end-t.media.duration)<.1,!(n.remaining>=t.config.preloadTime||i)){e.next=12;break}return i&&t._bufferService.msIsOpend&&t._bufferService.endOfStream(),e.abrupt("return");case 12:!t._urlSwitching&&t._prevSegSn!==r.sn-1&&n.end&&Math.abs(r.start-n.end)>1&&t._playlist.setNextSegmentByIndex(t._playlist.findSegmentIndexByTime(n.end+.1));case 13:return e.abrupt("return",t._loadSegmentDirect());case 14:case"end":return e.stop()}}),e)})))),U(V(t),"_onPlay",C(D().mark((function e(){return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.media.seeking||0!==t.media.currentTime){e.next=3;break}return xe.debug("replay currentTime 0, return"),e.abrupt("return");case 3:if(clearTimeout(t._disconnectTimer),!t._reloadOnPlay){e.next=9;break}t._reloadOnPlay=!1,t.replay(!0),e.next=12;break;case 9:return e.next=11,t._loadSegment();case 11:t._startTick();case 12:case"end":return e.stop()}}),e)})))),U(V(t),"_onPause",(function(){if(t.isLive){if(!t._reloadOnPlay){var e=t.config.disconnectTime;if(null==e&&(e=t._playlist.dvrWindow),!Number.isFinite(e))return;clearTimeout(t._disconnectTimer),t._disconnectTimer=setTimeout((function(){t._reloadOnPlay=!0,t._clear()}),e||0)}}else t._stopTick()})),U(V(t),"_onSeeking",C(D().mark((function e(){var r,n,i,a,s,u,c;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.media){e.next=2;break}return e.abrupt("return");case 2:if(t._onCheckQuotaExceeded(),r=t.media.currentTime,!(n=t._playlist.seekRange)){e.next=10;break}if(!((i=Se(r,n[0],t.isLive?n[1]:t.media.duration))>=0&&Math.abs(r-i)>=.1)){e.next=10;break}return t.media.currentTime=i,e.abrupt("return");case 10:if(a=t._playlist.currentSegment,s=o.info(o.get(t.media),r,.1),!a){e.next=15;break}if(!(s.end&&Math.abs(s.end-a.end)<.2)){e.next=15;break}return e.abrupt("return");case 15:if(u=t._playlist.findSegmentIndexByTime(r),c=t._playlist.getSegmentByIndex(u),null!=u&&c&&(!t._segmentProcessing||c!==t._playlist.nextSegment)){e.next=19;break}return e.abrupt("return");case 19:return xe.debug("seek to",r,c),t._playlist.setNextSegmentByIndex(u),t._stopTick(),e.next=24,t._segmentLoader.cancel();case 24:if(t._segmentProcessing=!1,s.end&&!t.isLive){e.next=28;break}return e.next=28,t._loadSegmentDirect(!0);case 28:t._startTick();case 29:case"end":return e.stop()}}),e)})))),U(V(t),"_onTimeupdate",(function(){if(t.media){var e,r=t.config;if(r.isLive&&r.maxLatency&&r.targetLatency&&t.media){var n=t._playlist.liveEdge;if(!n)return;var i=n-t.media.currentTime;i>=r.maxLatency&&(xe.debug("latency jump, currentTime:".concat(t.media.currentTime,", liveEdge:").concat(n,",  latency=").concat(i)),t.media.currentTime=n-r.targetLatency)}if(r.seiInTime)null===(e=t._seiService)||void 0===e||e.throw(t.media.currentTime);t.config.allowedStreamTrackChange&&!t.config.softDecode&&t._checkStreamTrackChange(t.media.currentTime)}})),U(V(t),"_tick",(function(){if(t.media){t._startTick();var e=t.media,r=o.get(e),n=t._segmentLoader.error;if(t._onCheckQuotaExceeded(),t._isProcessQuotaExceeded&&(t._bufferService.isFull()||(t._isProcessQuotaExceeded=!1,t._segmentProcessing=!1)),n){(!e.readyState||t.bufferInfo(.5).remaining<1)&&(n.fatal=!0,t._emitError(i.network(n)))}else o.end(r)<.1||!e.readyState||(l(e)?(t._loadSegment(),t._gapService&&t._gapService.do(e,t.config.maxJumpDistance,t.isLive)):e.readyState<2&&t._gapService&&t._gapService.do(e,t.config.maxJumpDistance,!e.currentTime||t.isLive))}})),t.config=(n=(null==(r=e)?void 0:r.media)||document.createElement("video"),e=A(A({maxPlaylistSize:50,retryCount:3,retryDelay:1e3,pollRetryCount:2,loadTimeout:1e4,manifestLoadTimeout:1e4,preloadTime:30,softDecode:!1,bufferBehind:10,maxJumpDistance:3,startTime:0,useLowLatency:!0,targetLatency:10,maxLatency:20,allowedStreamTrackChange:!0,seiInTime:!1,manifestList:[],minSegmentsStartPlay:3},r),{},{media:n})),t.media=t.config.media,t._manifestLoader=new _e(V(t)),t._segmentLoader=new Te(V(t)),t._playlist=new Ee(V(t)),t._bufferService=new q(V(t)),e.seiInTime&&(t._seiService=new h(V(t))),e.softDecode||(t._gapService=new d),t._stats=new f(V(t),9e4),t.media.addEventListener("play",t._onPlay),t.media.addEventListener("pause",t._onPause),t.media.addEventListener("seeking",t._onSeeking),t.media.addEventListener("timeupdate",t._onTimeupdate),t}return N(O,[{key:"isLive",get:function(){return this._playlist.isLive}},{key:"streams",get:function(){return this._playlist.streams}},{key:"currentStream",get:function(){return this._playlist.currentStream}},{key:"hasSubtitle",get:function(){return this._playlist.hasSubtitle}},{key:"baseDts",get:function(){var e;return null===(e=this._bufferService)||void 0===e?void 0:e.baseDts}},{key:"speedInfo",value:function(){return this._segmentLoader.speedInfo()}},{key:"bufferInfo",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.1;return o.info(o.get(this.media),null===(e=this.media)||void 0===e?void 0:e.currentTime,t)}},{key:"getStats",value:function(){return this._stats.getStats()}},{key:"playbackQuality",value:function(){return m(this.media)}},{key:"load",value:(w=C(D().mark((function e(t){var r,n=arguments;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.length>1&&void 0!==n[1]&&n[1],t&&(this.config.url=t),t=this.config.url,e.next=5,this._reset(r);case 5:return e.next=7,this._loadData(t);case 7:this._startTick();case 8:case"end":return e.stop()}}),e,this)}))),function(e){return w.apply(this,arguments)})},{key:"_loadData",value:(x=C(D().mark((function e(t){var r,n,s,o,u,c,l,h,d,f;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:try{t&&(t=t.trim())}catch(m){}if(t){e.next=3;break}throw this._emitError(new i(a.OTHER,a.SUB_TYPES.OPTION,null,null,"m3u8 url is missing"));case 3:return e.next=5,this._loadM3U8(t);case 5:if(r=e.sent,n=this._playlist.currentStream,!this._urlSwitching){e.next=17;break}if(0===n.bitrate&&null!==(s=this._switchUrlOpts)&&void 0!==s&&s.bitrate&&(n.bitrate=null===(o=this._switchUrlOpts)||void 0===o?void 0:o.bitrate),u=this._getSeamlessSwitchPoint(),this.config.startTime=u,c=this._playlist.findSegmentIndexByTime(u),!(l=this._playlist.getSegmentByIndex(c+1))){e.next=17;break}return h=l.start,e.next=17,this._bufferService.removeBuffer(h);case 17:if(r){e.next=19;break}return e.abrupt("return");case 19:if(!this.isLive){e.next=30;break}if(this._bufferService.setLiveSeekableRange(0,4294967295),xe.log("totalDuration first time got:",this._playlist.totalDuration),xe.log("nb segments got:",this._playlist.nbSegments),this.config.targetLatency<this._playlist.totalDuration&&(this.config.targetLatency=this._playlist.totalDuration,this.config.maxLatency=1.5*this.config.targetLatency),r.isMaster||this._pollM3U8(t),!(this._playlist.nbSegments<this.config.minSegmentsStartPlay)){e.next=27;break}return e.abrupt("return");case 27:return e.next=29,this._loadSegment();case 29:return e.abrupt("return");case 30:return e.next=32,this._bufferService.updateDuration(n.totalDuration);case 32:return(d=this.config.startTime)&&(null!==(f=this._switchUrlOpts)&&void 0!==f&&f.seamless||(this.media.currentTime=d),this._playlist.setNextSegmentByIndex(this._playlist.findSegmentIndexByTime(d)||0)),e.next=36,this._loadSegment();case 36:case"end":return e.stop()}}),e,this)}))),function(e){return x.apply(this,arguments)})},{key:"replay",value:(T=C(D().mark((function e(t){return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.config.startTime=0,e.next=3,this.load();case 3:return this._reloadOnPlay=!1,e.abrupt("return",this.media.play(!t));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return T.apply(this,arguments)})},{key:"switchURL",value:(E=C(D().mark((function e(t){var r,n,i,a,s,o,u,c=arguments;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=c.length>1&&void 0!==c[1]?c[1]:{},n={seamless:!1,startTime:0,bitrate:0},e.t0=I(r),e.next="number"===e.t0?5:"boolean"===e.t0?7:"object"===e.t0?9:11;break;case 5:return r={startTime:r},e.abrupt("break",12);case 7:return r={seamless:r},e.abrupt("break",12);case 9:for(i in r)void 0!==r[i]&&null!==r[i]||delete r[i];return e.abrupt("break",12);case 11:throw"unsupported switchURL args: ".concat(r);case 12:if(r=Object.assign({},n,r),s=(a=r).seamless,o=a.startTime,this.config.url=t,this.config.startTime=o,this._switchUrlOpts=r,s){e.next=38;break}if(e.prev=18,!this.config.softDecode){e.next=23;break}e.t1=this.load(t),e.next=26;break;case 23:return e.next=25,this.load(t);case 25:e.t1=e.sent;case 26:u=e.t1,e.next=33;break;case 29:throw e.prev=29,e.t2=e.catch(18),this.emit(Q.SWITCH_URL_FAILED,e.t2),e.t2;case 33:return this._reloadOnPlay=!1,u&&this.emit(Q.SWITCH_URL_SUCCESS,{url:t}),e.abrupt("return",this.media.play(!0));case 38:return this._urlSwitching=!0,this._prevSegSn=null,this._prevSegCc=null,this._playlist.reset(),this._bufferService.seamlessSwitch(),e.next=45,this._clear();case 45:return e.next=47,this._loadData(t);case 47:this._startTick();case 48:this._switchUrlOpts=null;case 49:case"end":return e.stop()}}),e,this,[[18,29]])}))),function(e){return E.apply(this,arguments)})},{key:"switchStream",value:(k=C(D().mark((function e(t){var r,n,a,s,o,u=arguments;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=!(u.length>1&&void 0!==u[1])||u[1],n=this.currentStream,a=this.streams,n&&n.id!==t&&a&&!(a.length<2)){e.next=5;break}return e.abrupt("return");case 5:if(s=a.find((function(e){return e.id===t}))){e.next=8;break}return e.abrupt("return");case 8:return e.prev=8,e.next=11,this._clear();case 11:if(!r){e.next=14;break}return e.next=14,this._bufferService.clearAllBuffer();case 14:e.next=19;break;case 16:throw e.prev=16,e.t0=e.catch(8),this._emitError(i.create(e.t0));case 19:if(n.currentAudioStream&&s.audioStreams.length>2&&(o=n.currentAudioStream.id,s.currentAudioStream=s.audioStreams.find((function(e){return e.id===o}))||s.currentAudioStream),this._playlist.currentStream=s,e.prev=21,!this.isLive&&s.segments.length){e.next=25;break}return e.next=25,this._refreshM3U8();case 25:return this._playlist.setNextSegmentByIndex(this._playlist.findSegmentIndexByTime(this.media.currentTime)||0),this._prevSegCc=null,e.next=29,this._loadSegmentDirect();case 29:e.next=35;break;case 31:throw e.prev=31,e.t1=e.catch(21),this._playlist.currentStream=n,e.t1;case 35:return this._startTick(),e.abrupt("return",s);case 37:case"end":return e.stop()}}),e,this,[[8,16],[21,31]])}))),function(e){return k.apply(this,arguments)})},{key:"switchAudioStream",value:(b=C(D().mark((function e(t){var r,n,a,s,o=arguments;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=!(o.length>1&&void 0!==o[1])||o[1],n=this.currentStream){e.next=4;break}return e.abrupt("return");case 4:if((a=n.currentAudioStream)&&a.id!==t&&!(n.audioStreams.length<2)){e.next=7;break}return e.abrupt("return");case 7:if(s=n.audioStreams.find((function(e){return e.id===t}))){e.next=10;break}return e.abrupt("return");case 10:return e.prev=10,e.next=13,this._clear();case 13:if(!r){e.next=16;break}return e.next=16,this._bufferService.clearAllBuffer();case 16:e.next=21;break;case 18:throw e.prev=18,e.t0=e.catch(10),this._emitError(i.create(e.t0));case 21:if(n.currentAudioStream=s,e.prev=22,!this.isLive&&s.segments.length){e.next=26;break}return e.next=26,this._refreshM3U8();case 26:return this._playlist.setNextSegmentByIndex(this._playlist.findSegmentIndexByTime(this.media.currentTime)||0),this._prevSegCc=null,e.next=30,this._loadSegmentDirect();case 30:e.next=36;break;case 32:throw e.prev=32,e.t1=e.catch(22),n.currentAudioStream=a,e.t1;case 36:return this._startTick(),e.abrupt("return",s);case 38:case"end":return e.stop()}}),e,this,[[10,18],[22,32]])}))),function(e){return b.apply(this,arguments)})},{key:"switchSubtitleStream",value:(_=C(D().mark((function e(t){return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._playlist.switchSubtitle(t),e.next=3,this._manifestLoader.stopPoll();case 3:return e.next=5,this._refreshM3U8();case 5:case"end":return e.stop()}}),e,this)}))),function(e){return _.apply(this,arguments)})},{key:"destroy",value:(g=C(D().mark((function e(){var t;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.media){e.next=2;break}return e.abrupt("return");case 2:return this.removeAllListeners(),this._playlist.reset(),this._segmentLoader.reset(),null===(t=this._seiService)||void 0===t||t.reset(),this.media.removeEventListener("play",this._onPlay),this.media.removeEventListener("pause",this._onPause),this.media.removeEventListener("seeking",this._onSeeking),this.media.removeEventListener("timeupdate",this._onTimeupdate),e.next=12,Promise.all([this._clear(),this._bufferService.destroy()]);case 12:this.media=null;case 13:case"end":return e.stop()}}),e,this)}))),function(){return g.apply(this,arguments)})},{key:"_loadM3U8",value:(y=C(D().mark((function e(t){var r,n,a,s,o,u,c;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!(s=null===(n=this.config.manifestList)||void 0===n||null===(a=n.filter((function(e){return e.url===t}))[0])||void 0===a?void 0:a.manifest)){e.next=6;break}e.t0=this._manifestLoader.parseText(s,t),e.next=9;break;case 6:return e.next=8,this._manifestLoader.load(t);case 8:e.t0=e.sent;case 9:o=e.t0,u=G(o,1),r=u[0],e.next=17;break;case 14:throw e.prev=14,e.t1=e.catch(0),this._emitError(i.create(e.t1));case 17:if(r){e.next=19;break}return e.abrupt("return");case 19:if(this._playlist.upsertPlaylist(r),!r.isMaster){e.next=24;break}return null!==(c=this._playlist.currentStream.subtitleStreams)&&void 0!==c&&c.length&&this.emit(Q.SUBTITLE_PLAYLIST,{list:this._playlist.currentStream.subtitleStreams}),e.next=24,this._refreshM3U8();case 24:return this.emit(Q.STREAM_PARSED),e.abrupt("return",r);case 26:case"end":return e.stop()}}),e,this,[[0,14]])}))),function(e){return y.apply(this,arguments)})},{key:"_refreshM3U8",value:function(){var e,t,r=this,n=this._playlist.currentStream;if(!n||!n.url)throw this._emitError(i.create(null,null,new Error("m3u8 url is not defined")));var a=n.url,s=null===(e=n.currentAudioStream)||void 0===e?void 0:e.url,o=null===(t=n.currentSubtitleStream)||void 0===t?void 0:t.url;return this._manifestLoader.load(a,s,o).then((function(e){var t=G(e,3),n=t[0],i=t[1],u=t[2];n&&(r._playlist.upsertPlaylist(n,i,u),r.isLive&&r._pollM3U8(a,s,o))})).catch((function(e){throw r._emitError(i.create(e))}))}},{key:"_pollM3U8",value:function(e,t,r){var n,a,s=this,o=this._playlist.isEmpty;this._playlist.lowLatency?n=1e3*(2*this._playlist.currentStream.partTargetDuration||0):n=1e3*((null===(a=this._playlist.lastSegment)||void 0===a?void 0:a.duration)||0);this._manifestLoader.poll(e,t,r,(function(e,t,r){s._playlist.upsertPlaylist(e,t,r),s._playlist.clearOldSegment(),(e&&o&&!s._playlist.isEmpty||!s._playlist.hadSegmentLoaded&&s._playlist.nbSegments>=s.config.minSegmentsStartPlay)&&s._loadSegment(),o&&(o=s._playlist.isEmpty)}),(function(e){s._emitError(i.create(e))}),n)}},{key:"_loadSegmentDirect",value:(v=C(D().mark((function e(t){var r,n,a;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this._playlist.nextSegment){e.next=3;break}return e.abrupt("return");case 3:return n=!1,a=null,e.prev=5,this._segmentProcessing=!0,xe.log("load segment, sn:".concat(r.sn,", partIndex:").concat(r.partIndex)),e.next=10,this._reqAndBufferSegment(r,this._playlist.getAudioSegment(r));case 10:n=e.sent,e.next=16;break;case 13:e.prev=13,e.t0=e.catch(5),a=e.t0;case 16:return e.prev=16,this._segmentProcessing=!1,e.finish(16);case 19:if(!a){e.next=26;break}if(!this._bufferService.isFull()){e.next=25;break}return xe.log("load segment, sn:".concat(r.sn,", partIndex:").concat(r.partIndex)),this._segmentProcessing=!0,this._isProcessQuotaExceeded=!0,e.abrupt("return",!1);case 25:return e.abrupt("return",this._emitError(i.create(a)));case 26:return n&&(this._urlSwitching&&(this._urlSwitching=!1,this.emit(Q.SWITCH_URL_SUCCESS,{url:this.config.url})),this._playlist.moveSegmentPointer(),r.isLast?this._end():t||this._loadSegment()),e.abrupt("return",n);case 28:case"end":return e.stop()}}),e,this,[[5,13,16,19]])}))),function(e){return v.apply(this,arguments)})},{key:"_reqAndBufferSegment",value:(p=C(D().mark((function e(t,r){var n,i,a,s,o,u,c,l,h;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=t?t.cc:r.cc,a=this._prevSegCc!==i,s=[],e.prev=3,e.next=6,this._segmentLoader.load(t,r,a);case 6:s=e.sent,e.next=14;break;case 9:throw e.prev=9,e.t0=e.catch(3),e.t0.fatal=!1,this._segmentLoader.error=e.t0,e.t0;case 14:if(s[0]){e.next=16;break}return e.abrupt("return");case 16:return e.next=18,(n=this._bufferService).decryptBuffer.apply(n,H(s));case 18:if(o=e.sent){e.next=21;break}return e.abrupt("return");case 21:return u=t?t.sn:r.sn,c=t?t.start:r.start,l=this._playlist.currentStream,this._bufferService.createSource(o[0],o[1],null==l?void 0:l.videoCodec,null==l?void 0:l.audioCodec),h=Date.now(),e.next=28,this._bufferService.appendBuffer(t,r,o[0],o[1],a,this._prevSegSn===u-1,c);case 28:return this.emit(Q.APPEND_COST,{elapsed:Date.now()-h,url:t.url}),e.next=31,this._bufferService.evictBuffer(this.config.bufferBehind);case 31:return this._prevSegCc=i,this._prevSegSn=u,e.abrupt("return",!0);case 34:case"end":return e.stop()}}),e,this,[[3,9]])}))),function(e,t){return p.apply(this,arguments)})},{key:"_onCheckQuotaExceeded",value:(c=C(D().mark((function e(){var t,r,n,i,a,s;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=this.media.currentTime,r=this.media.buffered,n=!1,i=0;case 4:if(!(i<r.length)){e.next=11;break}if(!(r.start(0)>=t&&t<r.end(i))){e.next=8;break}return n=!0,e.abrupt("break",11);case 8:i++,e.next=4;break;case 11:if(!this._bufferService.isFull()){e.next=17;break}if(a=n?this.config.bufferBehind:5,!((s=this.media.currentTime)-a>0)){e.next=17;break}return e.next=17,this._bufferService.removeBuffer(0,s-a);case 17:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"_checkStreamTrackChange",value:function(e){var t=this._playlist.checkSegmentTrackChange(e,this._bufferService.nbSb);t&&this.switchURL(this.config.url,t.start+.2)}},{key:"_clear",value:(u=C(D().mark((function e(){return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return clearTimeout(this._disconnectTimer),this._stopTick(),e.next=4,Promise.all([this._segmentLoader.cancel(),this._manifestLoader.stopPoll()]);case 4:this._segmentProcessing=!1;case 5:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"_reset",value:(r=C(D().mark((function e(){var t,r,n=arguments;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.length>0&&void 0!==n[0]&&n[0],this._reloadOnPlay=!1,this._prevSegSn=null,this._prevSegCc=null,this._switchUrlOpts=null,this._playlist.reset(),this._segmentLoader.reset(),null===(t=this._seiService)||void 0===t||t.reset(),this._stats.reset(),e.next=11,this._clear();case 11:return e.abrupt("return",this._bufferService.reset(r));case 12:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"_end",value:function(){this._clear(),this._bufferService.endOfStream(),(this.media.readyState<=2||this.media.buffered.length>1)&&this._startTick()}},{key:"_stopTick",value:function(){this._tickTimer&&clearTimeout(this._tickTimer),this._tickTimer=null}},{key:"_startTick",value:function(){this._stopTick(),this._tickTimer=setTimeout(this._tick,this._tickInterval)}},{key:"_emitError",value:function(e){var t,r,n,i,a=arguments.length>1&&void 0!==arguments[1]&&arguments[1];!1===(null===(t=e.originError)||void 0===t?void 0:t.fatal)?xe.warn(e):(xe.table(e),xe.error(e),xe.error(null===(r=this.media)||void 0===r?void 0:r.error),null!==(n=this.media)&&void 0!==n&&n.readyState&&this.media.pause(),this._stopTick(),this._urlSwitching&&(this._urlSwitching=!1,this.emit(Q.SWITCH_URL_FAILED,e)),this.emit(Q.ERROR,e),a&&this._end(),null===(i=this._seiService)||void 0===i||i.reset());return e}},{key:"_getSeamlessSwitchPoint",value:function(){var e=this.media,t=e.currentTime;if(!e.paused){var r,n=this._playlist.findSegmentIndexByTime(e.currentTime),i=this._playlist.getSegmentByIndex(n),a=null===(r=this._stats)||void 0===r?void 0:r.getStats().downloadSpeed;if(a&&i)t+=i.duration*this._playlist.currentStream.bitrate/a+1;else t+=5}return t}}],[{key:"isSupported",value:function(e){return e&&"video"!==e&&"audio"!==e?"undefined"!=typeof WebAssembly:s.isSupported()}},{key:"enableLogger",value:function(){n.enable(),S.enable()}},{key:"disableLogger",value:function(){n.disable(),S.disable()}}]),O}();U(we,"version","3.0.12");try{localStorage.getItem("xgd")?we.enableLogger():we.disableLogger()}catch(De){}var Le=function(){function e(t,r){var n=this;P(this,e),U(this,"_opts",null),U(this,"_plugin",null),U(this,"_onLowDecode",(function(){var e,t,r,i,a=n._opts,s=a.media,o=a.innerDegrade;null===(e=n._plugin)||void 0===e||null===(t=e.player)||void 0===t||t.emit("lowdecode",s.degradeInfo),null===(r=n._plugin)||void 0===r||null===(i=r.player)||void 0===i||i.emit("core_event",A(A({},s.degradeInfo),{},{eventName:Q.LOWDECODE})),1===o&&n._degrade(s.src)})),U(this,"_degrade",(function(e){var t=n._plugin.player,r=t.video;if(!r||"MVideo"===r.TAG){var i=t.video.degradeVideo;t.video=i,r.degrade(e),e&&(t.config.url=e);var a=t.root.firstChild;"MVideo"===a.TAG&&t.root.replaceChild(i,a);var s=n._plugin.constructor.pluginName.toLowerCase();t.unRegisterPlugin(s),t.once("canplay",(function(){t.play()}))}})),U(this,"forceDegradeToVideo",(function(e){1===n._opts.innerDegrade&&n._degrade(e)})),this._opts=t,this._plugin=r,this._init()}return N(e,[{key:"_init",value:function(){var e=this._opts,t=e.media,r=e.preloadTime,n=e.innerDegrade,i=e.isLive;t&&(i||!t.setPlayMode?(n&&t.setAttribute("innerdegrade",n),r&&t.setAttribute("preloadtime",r),this._bindEvents()):t.setPlayMode("VOD"))}},{key:"_bindEvents",value:function(){this._opts.media.addEventListener("lowdecode",this._onLowDecode)}},{key:"destroy",value:function(){var e,t;null===(e=this._opts)||void 0===e||null===(t=e.media)||void 0===t||t.removeEventListener("lowdecode",this._onLowDecode),this._plugin=null}}]),e}();var Ae=function(e){B(n,b);var t=j(n);function n(){var e;P(this,n);for(var r=arguments.length,i=new Array(r),a=0;a<r;a++)i[a]=arguments[a];return U(V(e=t.call.apply(t,[this].concat(i))),"hls",null),U(V(e),"pluginExtension",null),U(V(e),"getStats",(function(){var t;return null===(t=e.hls)||void 0===t?void 0:t.getStats()})),U(V(e),"_onSwitchSubtitle",(function(t){var r,n=t.lang;null===(r=e.hls)||void 0===r||r.switchSubtitleStream(n)})),U(V(e),"_onSwitchURL",(function(t,r){var n=V(e),i=n.player,a=n.hls;if(a){var s,o,u=function(e,t){var r={startTime:t.player.currentTime};switch(I(e)){case"boolean":r.seamless=e;break;case"object":Object.assign(r,e)}return r}(r,V(e));i.config.url=t,a.switchURL(t,u).catch((function(e){})),!u.seamless&&null!==(s=e.player.config)&&void 0!==s&&null!==(o=s.hls)&&void 0!==o&&o.keepStatusAfterSwitch&&e._keepPauseStatus()}})),U(V(e),"_keepPauseStatus",(function(){e.player.paused&&e.player.once("canplay",(function(){e.player.pause()}))})),e}return N(n,[{key:"core",get:function(){return this.hls}},{key:"version",get:function(){var e;return null===(e=this.hls)||void 0===e?void 0:e.version}},{key:"softDecode",get:function(){var e,t,r=null===(e=this.player)||void 0===e||null===(t=e.config)||void 0===t?void 0:t.mediaType;return!!r&&"video"!==r&&"audio"!==r}},{key:"beforePlayerInit",value:function(){var e=this,t=this.player.config;if(t.url||t.__allowHlsEmptyUrl__){this.hls&&this.hls.destroy(),this.player.switchURL=this._onSwitchURL;var n,i=t.hls||{};if(i.innerDegrade=i.innerDegrade||t.innerDegrade,null!==i.disconnectTime&&void 0!==i.disconnectTime||(i.disconnectTime=0),this.hls=new we(A({softDecode:this.softDecode,isLive:t.isLive,media:this.player.media||this.player.video,startTime:t.startTime,url:t.url},i)),this.softDecode||b.defineGetterOrSetter(this.player,{url:{get:function(){var t,r;return null===(t=e.hls)||void 0===t||null===(r=t.media)||void 0===r?void 0:r.src},configurable:!0}}),this.softDecode&&(this.pluginExtension=new Le(A({isLive:t.isLive,media:this.player.video},i),this),this.player.forceDegradeToVideo=function(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return null===(t=e.pluginExtension)||void 0===t?void 0:t.forceDegradeToVideo.apply(t,n)}),t.isLive)null===(n=this.player)||void 0===n||n.useHooks("replay",(function(){var t;return null===(t=e.hls)||void 0===t?void 0:t.replay()}));this.on(k,this._onSwitchSubtitle),this.on(E,this._onSwitchURL),this.on(T,this.destroy.bind(this)),this._transError(),this._transCoreEvent(r.TTFB),this._transCoreEvent(r.LOAD_START),this._transCoreEvent(r.LOAD_RESPONSE_HEADERS),this._transCoreEvent(r.LOAD_COMPLETE),this._transCoreEvent(r.LOAD_RETRY),this._transCoreEvent(r.SOURCEBUFFER_CREATED),this._transCoreEvent(r.REMOVE_BUFFER),this._transCoreEvent(r.BUFFEREOS),this._transCoreEvent(r.KEYFRAME),this._transCoreEvent(r.METADATA_PARSED),this._transCoreEvent(r.DEMUXED_TRACK),this._transCoreEvent(r.SEI),this._transCoreEvent(r.SEI_IN_TIME),this._transCoreEvent(r.SPEED),this._transCoreEvent(r.HLS_MANIFEST_LOADED),this._transCoreEvent(r.HLS_LEVEL_LOADED),this._transCoreEvent(r.STREAM_EXCEPTION),this._transCoreEvent(r.SWITCH_URL_SUCCESS),this._transCoreEvent(r.SWITCH_URL_FAILED),this._transCoreEvent(Q.NO_AUDIO_TRACK),this._transCoreEvent(Q.STREAM_PARSED),this._transCoreEvent(Q.SUBTITLE_SEGMENTS),this._transCoreEvent(Q.SUBTITLE_PLAYLIST),this._transCoreEvent(Q.APPEND_COST),t.url&&this.hls.load(t.url,!0).catch((function(e){}))}}},{key:"destroy",value:function(){var e;this.hls&&(this.hls.destroy(),this.hls=null),null===(e=this.pluginExtension)||void 0===e||e.destroy(),this.pluginExtension=null}},{key:"_transError",value:function(){var e=this;this.hls.on(Q.ERROR,(function(t){e.player&&e.player.emit(x,new w(e.player,t))}))}},{key:"_transCoreEvent",value:function(e){var t=this;this.hls.on(e,(function(n){t.player&&(t.player.emit("core_event",A(A({},n),{},{eventName:e})),e===r.SEI_IN_TIME&&t.hls.hasSubtitle&&t._emitSeiPaylodTime(n))}))}},{key:"_emitSeiPaylodTime",value:function(e){try{var t=JSON.parse(Array.from(e.data.payload).map((function(e){return String.fromCharCode(e)})).join("").slice(0,-1));if(!t.rtmp_dts)return;this.player.emit("core_event",{eventName:Q.SEI_PAYLOAD_TIME,time:t.rtmp_dts})}catch(r){}}}],[{key:"pluginName",get:function(){return"hls"}},{key:"isSupported",value:function(e,t){return we.isSupported(e,t)}}]),n}();U(Ae,"Hls",we),U(Ae,"EVENT",Q);export{Ae as H};
