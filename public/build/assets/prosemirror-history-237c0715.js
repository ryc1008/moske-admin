import{R as e}from"./rope-sequence-72d4f3ff.js";import{M as t}from"./prosemirror-transform-0ba15ba3.js";import{a as n,P as s}from"./prosemirror-state-425d0e8b.js";class i{constructor(e,t){this.items=e,this.eventCount=t}popEvent(e,t){if(0==this.eventCount)return null;let n,s,o=this.items.length;for(;;o--){if(this.items.get(o-1).selection){--o;break}}t&&(n=this.remapping(o,this.items.length),s=n.maps.length);let p,a,l=e.tr,m=[],h=[];return this.items.forEach(((e,t)=>{if(!e.step)return n||(n=this.remapping(o,t+1),s=n.maps.length),s--,void h.push(e);if(n){h.push(new r(e.map));let t,i=e.step.map(n.slice(s));i&&l.maybeStep(i).doc&&(t=l.mapping.maps[l.mapping.maps.length-1],m.push(new r(t,void 0,void 0,m.length+h.length))),s--,t&&n.appendMap(t,s)}else l.maybeStep(e.step);return e.selection?(p=n?e.selection.map(n.slice(s)):e.selection,a=new i(this.items.slice(0,o).append(h.reverse().concat(m)),this.eventCount-1),!1):void 0}),this.items.length,0),{remaining:a,transform:l,selection:p}}addTransform(e,t,n,s){let o=[],a=this.eventCount,l=this.items,m=!s&&l.length?l.get(l.length-1):null;for(let i=0;i<e.steps.length;i++){let n,p=e.steps[i].invert(e.docs[i]),h=new r(e.mapping.maps[i],p,t);(n=m&&m.merge(h))&&(h=n,i?o.pop():l=l.slice(0,l.length-1)),o.push(h),t&&(a++,t=void 0),s||(m=h)}let h=a-n.depth;return h>p&&(l=function(e,t){let n;return e.forEach(((e,s)=>{if(e.selection&&0==t--)return n=s,!1})),e.slice(n)}(l,h),a-=h),new i(l.append(o),a)}remapping(e,n){let s=new t;return this.items.forEach(((t,n)=>{let i=null!=t.mirrorOffset&&n-t.mirrorOffset>=e?s.maps.length-t.mirrorOffset:void 0;s.appendMap(t.map,i)}),e,n),s}addMaps(e){return 0==this.eventCount?this:new i(this.items.append(e.map((e=>new r(e)))),this.eventCount)}rebased(e,t){if(!this.eventCount)return this;let n=[],s=Math.max(0,this.items.length-t),o=e.mapping,p=e.steps.length,a=this.eventCount;this.items.forEach((e=>{e.selection&&a--}),s);let l=t;this.items.forEach((t=>{let s=o.getMirror(--l);if(null==s)return;p=Math.min(p,s);let i=o.maps[s];if(t.step){let p=e.steps[s].invert(e.docs[s]),m=t.selection&&t.selection.map(o.slice(l+1,s));m&&a++,n.push(new r(i,p,m))}else n.push(new r(i))}),s);let m=[];for(let i=t;i<p;i++)m.push(new r(o.maps[i]));let h=this.items.slice(0,s).append(m).append(n),u=new i(h,a);return u.emptyItemCount()>500&&(u=u.compress(this.items.length-n.length)),u}emptyItemCount(){let e=0;return this.items.forEach((t=>{t.step||e++})),e}compress(t=this.items.length){let n=this.remapping(0,t),s=n.maps.length,o=[],p=0;return this.items.forEach(((e,i)=>{if(i>=t)o.push(e),e.selection&&p++;else if(e.step){let t=e.step.map(n.slice(s)),i=t&&t.getMap();if(s--,i&&n.appendMap(i,s),t){let a=e.selection&&e.selection.map(n.slice(s));a&&p++;let l,m=new r(i.invert(),t,a),h=o.length-1;(l=o.length&&o[h].merge(m))?o[h]=l:o.push(m)}}else e.map&&s--}),this.items.length,0),new i(e.from(o.reverse()),p)}}i.empty=new i(e.empty,0);class r{constructor(e,t,n,s){this.map=e,this.step=t,this.selection=n,this.mirrorOffset=s}merge(e){if(this.step&&e.step&&!e.selection){let t=e.step.merge(this.step);if(t)return new r(t.getMap().invert(),t,this.selection)}}}class o{constructor(e,t,n,s,i){this.done=e,this.undone=t,this.prevRanges=n,this.prevTime=s,this.prevComposition=i}}const p=20;function a(e){let t=[];return e.forEach(((e,n,s,i)=>t.push(s,i))),t}function l(e,t){if(!e)return null;let n=[];for(let s=0;s<e.length;s+=2){let i=t.map(e[s],1),r=t.map(e[s+1],-1);i<=r&&n.push(i,r)}return n}function m(e,t,n,s){let i=g(t),r=d.get(t).spec.config,p=(s?e.undone:e.done).popEvent(t,i);if(!p)return;let a=p.selection.resolve(p.transform.doc),l=(s?e.done:e.undone).addTransform(p.transform,t.selection.getBookmark(),r,i),m=new o(s?l:p.remaining,s?p.remaining:l,null,0,-1);n(p.transform.setSelection(a).setMeta(d,{redo:s,historyState:m}).scrollIntoView())}let h=!1,u=null;function g(e){let t=e.plugins;if(u!=t){h=!1,u=t;for(let e=0;e<t.length;e++)if(t[e].spec.historyPreserveItems){h=!0;break}}return h}const d=new n("history"),c=new n("closeHistory");function f(e={}){return e={depth:e.depth||100,newGroupDelay:e.newGroupDelay||500},new s({key:d,state:{init:()=>new o(i.empty,i.empty,null,0,-1),apply:(t,n,s)=>function(e,t,n,s){let r,p=n.getMeta(d);if(p)return p.historyState;n.getMeta(c)&&(e=new o(e.done,e.undone,null,0,-1));let m=n.getMeta("appendedTransaction");if(0==n.steps.length)return e;if(m&&m.getMeta(d))return m.getMeta(d).redo?new o(e.done.addTransform(n,void 0,s,g(t)),e.undone,a(n.mapping.maps[n.steps.length-1]),e.prevTime,e.prevComposition):new o(e.done,e.undone.addTransform(n,void 0,s,g(t)),null,e.prevTime,e.prevComposition);if(!1===n.getMeta("addToHistory")||m&&!1===m.getMeta("addToHistory"))return(r=n.getMeta("rebased"))?new o(e.done.rebased(n,r),e.undone.rebased(n,r),l(e.prevRanges,n.mapping),e.prevTime,e.prevComposition):new o(e.done.addMaps(n.mapping.maps),e.undone.addMaps(n.mapping.maps),l(e.prevRanges,n.mapping),e.prevTime,e.prevComposition);{let r=n.getMeta("composition"),p=0==e.prevTime||!m&&e.prevComposition!=r&&(e.prevTime<(n.time||0)-s.newGroupDelay||!function(e,t){if(!t)return!1;if(!e.docChanged)return!0;let n=!1;return e.mapping.maps[0].forEach(((e,s)=>{for(let i=0;i<t.length;i+=2)e<=t[i+1]&&s>=t[i]&&(n=!0)})),n}(n,e.prevRanges)),h=m?l(e.prevRanges,n.mapping):a(n.mapping.maps[n.steps.length-1]);return new o(e.done.addTransform(n,p?t.selection.getBookmark():void 0,s,g(t)),i.empty,h,n.time,null==r?e.prevComposition:r)}}(n,s,t,e)},config:e,props:{handleDOMEvents:{beforeinput(e,t){let n=t.inputType,s="historyUndo"==n?v:"historyRedo"==n?w:null;return!!s&&(t.preventDefault(),s(e.state,e.dispatch))}}}})}const v=(e,t)=>{let n=d.getState(e);return!(!n||0==n.done.eventCount)&&(t&&m(n,e,t,!1),!0)},w=(e,t)=>{let n=d.getState(e);return!(!n||0==n.undone.eventCount)&&(t&&m(n,e,t,!0),!0)};function y(e){let t=d.getState(e);return t?t.done.eventCount:0}function M(e){let t=d.getState(e);return t?t.undone.eventCount:0}export{y as a,M as b,f as h,w as r,v as u};
