function e(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,f(i.key),i)}}function a(e,a,i){return a&&t(e.prototype,a),i&&t(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function i(e,t,a){return(t=f(t))in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function n(e){return(n=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function r(e,t){return(r=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function s(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function o(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var a,i=n(e);if(t){var r=n(this).constructor;a=Reflect.construct(i,arguments,r)}else a=i.apply(this,arguments);return s(this,a)}}function u(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var a=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=a){var i,n,r,s,o=[],u=!0,c=!1;try{if(r=(a=a.call(e)).next,0===t){if(Object(a)!==a)return;u=!1}else for(;!(u=(i=r.call(a)).done)&&(o.push(i.value),o.length!==t);u=!0);}catch(l){c=!0,n=l}finally{try{if(!u&&null!=a.return&&(s=a.return(),Object(s)!==s))return}finally{if(c)throw n}}return o}}(e,t)||l(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function c(e){return function(e){if(Array.isArray(e))return d(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||l(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function l(e,t){if(e){if("string"==typeof e)return d(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);return"Object"===a&&e.constructor&&(a=e.constructor.name),"Map"===a||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?d(e,t):void 0}}function d(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,i=new Array(t);a<t;a++)i[a]=e[a];return i}function f(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var a=e[Symbol.toPrimitive];if(void 0!==a){var i=a.call(e,t||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}var h="video",p="audio",v="metadata",m="avc",y="hevc",b="aac",g="g7110a",k="g7110m",_={LARGE_AV_SHIFT:"LARGE_AV_SHIFT",LARGE_VIDEO_GAP:"LARGE_VIDEO_GAP",LARGE_VIDEO_GAP_BETWEEN_CHUNK:"LARGE_VIDEO_GAP_BETWEEN_CHUNK",LARGE_AUDIO_GAP:"LARGE_AUDIO_GAP",AUDIO_FILLED:"AUDIO_FILLED",AUDIO_DROPPED:"AUDIO_DROPPED"},x=function(){function t(){e(this,t),i(this,"id",1),i(this,"type",h),i(this,"codecType",m),i(this,"pid",-1),i(this,"hvcC",void 0),i(this,"codec",""),i(this,"timescale",0),i(this,"formatTimescale",0),i(this,"sequenceNumber",0),i(this,"baseMediaDecodeTime",0),i(this,"baseDts",0),i(this,"duration",0),i(this,"warnings",[]),i(this,"samples",[]),i(this,"pps",[]),i(this,"sps",[]),i(this,"vps",[]),i(this,"fpsNum",0),i(this,"fpsDen",0),i(this,"sarRatio",[]),i(this,"width",0),i(this,"height",0),i(this,"nalUnitSize",4),i(this,"present",!1),i(this,"isVideoEncryption",!1),i(this,"isAudioEncryption",!1),i(this,"isVideo",!0),i(this,"kid",null),i(this,"pssh",null),i(this,"ext",void 0)}return a(t,[{key:"reset",value:function(){this.sequenceNumber=this.width=this.height=this.fpsDen=this.fpsNum=this.duration=this.baseMediaDecodeTime=this.timescale=0,this.codec="",this.present=!1,this.pid=-1,this.pps=[],this.sps=[],this.vps=[],this.sarRatio=[],this.samples=[],this.warnings=[],this.hvcC=null}},{key:"exist",value:function(){return!!(this.pps.length&&this.sps.length&&this.codec)}},{key:"hasSample",value:function(){return!!this.samples.length}},{key:"isEncryption",get:function(){return this.isVideoEncryption}}]),t}(),w=function(){function t(){e(this,t),i(this,"id",2),i(this,"type",p),i(this,"codecType",b),i(this,"pid",-1),i(this,"codec",""),i(this,"sequenceNumber",0),i(this,"sampleDuration",0),i(this,"timescale",0),i(this,"formatTimescale",0),i(this,"baseMediaDecodeTime",0),i(this,"duration",0),i(this,"warnings",[]),i(this,"samples",[]),i(this,"baseDts",0),i(this,"sampleSize",16),i(this,"sampleRate",0),i(this,"channelCount",0),i(this,"objectType",0),i(this,"sampleRateIndex",0),i(this,"config",[]),i(this,"present",!1),i(this,"isVideoEncryption",!1),i(this,"isAudioEncryption",!1),i(this,"kid",null),i(this,"ext",void 0)}return a(t,[{key:"reset",value:function(){this.sequenceNumber=0,this.timescale=0,this.sampleDuration=0,this.sampleRate=0,this.channelCount=0,this.baseMediaDecodeTime=0,this.present=!1,this.pid=-1,this.codec="",this.samples=[],this.config=[],this.warnings=[]}},{key:"exist",value:function(){return!!(this.sampleRate&&this.channelCount&&this.codec&&this.codecType===b)}},{key:"hasSample",value:function(){return!!this.samples.length}},{key:"isEncryption",get:function(){return this.isAudioEncryption}}]),t}(),A=function(){function t(a,n,r){e(this,t),i(this,"flag",{}),i(this,"keyframe",!1),i(this,"gopId",0),i(this,"duration",0),i(this,"size",0),i(this,"units",[]),i(this,"chromaFormat",420),this.originPts=this.pts=a,this.originDts=this.dts=n,r&&(this.units=r)}return a(t,[{key:"cts",get:function(){return this.pts-this.dts}},{key:"setToKeyframe",value:function(){this.keyframe=!0,this.flag.dependsOn=2,this.flag.isNonSyncSample=0}}]),t}(),D=a((function t(a,n,r,s){e(this,t),i(this,"duration",1024),i(this,"flag",{dependsOn:2,isNonSyncSample:0}),i(this,"keyframe",!0),this.originPts=this.pts=this.dts=a,this.data=n,this.size=n.byteLength,this.sampleOffset=s,r&&(this.duration=r)})),E=a((function t(a,n){e(this,t),i(this,"time",0),this.data=a,this.originPts=this.pts=n})),S=function(t){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&r(e,t)}(n,E);var i=o(n);function n(){return e(this,n),i.apply(this,arguments)}return a(n)}(),T=function(){function t(){e(this,t),i(this,"id",3),i(this,"type",v),i(this,"timescale",0),i(this,"flvScriptSamples",[]),i(this,"seiSamples",[])}return a(t,[{key:"exist",value:function(){return!(!this.flvScriptSamples.length&&!this.seiSamples.length||!this.timescale)}},{key:"reset",value:function(){this.timescale=0,this.flvScriptSamples=[],this.seiSamples=[]}},{key:"hasSample",value:function(){return!(!this.flvScriptSamples.length&&!this.seiSamples.length)}}]),t}(),B=function(){function t(a){e(this,t),this.name=a||"",this._prefix="[".concat(this.name,"]")}return a(t,[{key:"warn",value:function(){var e;if(!t.disabled){for(var a=arguments.length,i=new Array(a),n=0;n<a;n++)i[n]=arguments[n];(e=console).warn.apply(e,[this._prefix].concat(i))}}}],[{key:"enable",value:function(){t.disabled=!1}},{key:"disable",value:function(){t.disabled=!0}}]),t}();i(B,"disabled",!0);var U="undefined"!=typeof window,C=U&&navigator.userAgent.toLocaleLowerCase(),P=U&&/^((?!chrome|android).)*safari/.test(C),I=U&&C.includes("firefox"),M=U&&C.includes("android"),R=function(){function t(){e(this,t)}return a(t,null,[{key:"getRateIndexByRate",value:function(e){return t.FREQ.indexOf(e)}},{key:"parseADTS",value:function(e,a){for(var i=e.length,n=0;n+2<i&&(255!==e[n]||240!=(246&e[n+1]));)n++;if(!(n>=i)){var r=n,s=[],o=(60&e[n+2])>>>2,u=t.FREQ[o];if(!u)throw new Error("Invalid sampling index: ".concat(o));for(var c,l,d=1+((192&e[n+2])>>>6),f=(1&e[n+2])<<2|(192&e[n+3])>>>6,h=t._getConfig(o,f,d),p=h.config,v=h.codec,m=0,y=t.getFrameDuration(u);n+7<i;)if(255===e[n]&&240==(246&e[n+1])){if(i-n<(l=(3&e[n+3])<<11|e[n+4]<<3|(224&e[n+5])>>5))break;c=2*(1&~e[n+1]),s.push({pts:a+m*y,data:e.subarray(n+7+c,n+l)}),m++,n+=l}else n++;return{skip:r,remaining:n>=i?void 0:e.subarray(n),frames:s,samplingFrequencyIndex:o,sampleRate:u,objectType:d,channelCount:f,codec:v,config:p,originCodec:"mp4a.40.".concat(d)}}}},{key:"parseAudioSpecificConfig",value:function(e){if(e.length){var a=e[0]>>>3,i=(7&e[0])<<1|e[1]>>>7,n=(120&e[1])>>>3,r=t.FREQ[i];if(r){var s=t._getConfig(i,n,a);return{samplingFrequencyIndex:i,sampleRate:r,objectType:a,channelCount:n,config:s.config,codec:s.codec,originCodec:"mp4a.40.".concat(a)}}}}},{key:"getFrameDuration",value:function(e){return 1024*(arguments.length>1&&void 0!==arguments[1]?arguments[1]:9e4)/e}},{key:"_getConfig",value:function(e,t,a){var i,n,r=[];return I?e>=6?(i=5,n=e-3):(i=2,n=e):M?(i=2,n=e):(i=2===a||5===a?a:5,n=e,e>=6?n=e-3:1===t&&(i=2,n=e)),r[0]=i<<3,r[0]|=(14&e)>>1,r[1]=(1&e)<<7,r[1]|=t<<3,5===i&&(r[1]|=(14&n)>>1,r[2]=(1&n)<<7,r[2]|=8,r[3]=0),{config:r,codec:"mp4a.40.".concat(i)}}},{key:"getSilentFrame",value:function(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}}}]),t}();function z(){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++)t[a]=arguments[a];t=t.filter(Boolean);var i=new Uint8Array(t.reduce((function(e,t){return e+t.byteLength}),0)),n=0;return t.forEach((function(e){i.set(e,n),n+=e.byteLength})),i}i(R,"FREQ",[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350]);var L=Math.pow(2,32);function V(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return(e[t]<<8)+(e[t+1]||0)}function O(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return(e[t]<<24>>>0)+(e[t+1]<<16)+(e[t+2]<<8)+(e[t+3]||0)}function G(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return O(e,t)*L+O(e,t+4)}function N(e){for(var t,a="avc1.",i=0;i<3;i++)(t=e[i].toString(16)).length<2&&(t="0".concat(t)),a+=t;return a}function F(e){if(!Array.isArray(e)){for(var t=[],a="",i=0;i<e.length;i++)i%2&&(a=e[i-1]+e[i],t.push(parseInt(a,16)),a="");return t}return e.map((function(e){return parseInt(e,16)}))}var j=function(){function t(){e(this,t)}return a(t,null,[{key:"parseAnnexB",value:function(e){for(var t=e.length,a=2,i=0;null!==e[a]&&void 0!==e[a]&&1!==e[a];)a++;if((i=++a+2)>=t)return[];for(var n=[];i<t;)switch(e[i]){case 0:if(0!==e[i-1]){i+=2;break}if(0!==e[i-2]){i++;break}a!==i-2&&n.push(e.subarray(a,i-2));do{i++}while(1!==e[i]&&i<t);i=(a=i+1)+2;break;case 1:if(0!==e[i-1]||0!==e[i-2]){i+=3;break}a!==i-2&&n.push(e.subarray(a,i-2)),i=(a=i+1)+2;break;default:i+=3}return a<t&&n.push(e.subarray(a)),n}},{key:"parseAvcC",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4;if(!(e.length<4)){for(var a,i=e.length,n=[],r=0;r+t<i;)if(a=O(e,r),3===t&&(a>>>=8),r+=t,a){if(r+a>i)break;n.push(e.subarray(r,r+a)),r+=a}return n}}},{key:"parseSEI",value:function(e,t){for(var a=e.length,i=t?2:1,n=0,r=0,s="";255===e[i];)n+=255,i++;for(n+=e[i++];255===e[i];)r+=255,i++;if(r+=e[i++],5===n&&a>i+16)for(var o=0;o<16;o++)s+=e[i].toString(16),i++;return{payload:e.subarray(i,i+r),type:n,size:r,uuid:s}}},{key:"removeEPB",value:function(e){for(var t=e.byteLength,a=[],i=1;i<t-2;)0===e[i]&&0===e[i+1]&&3===e[i+2]?(a.push(i+2),i+=2):i++;if(!a.length)return e;var n=t-a.length,r=new Uint8Array(n),s=0;for(i=0;i<n;s++,i++)s===a[0]&&(s++,a.shift()),r[i]=e[s];return r}}]),t}(),H=function(){function t(a){if(e(this,t),i(this,"_bytesAvailable",void 0),i(this,"_bitsAvailable",0),i(this,"_word",0),!a)throw new Error("ExpGolomb data params is required");this._data=a,this._bytesAvailable=a.byteLength,this._bytesAvailable&&this._loadWord()}return a(t,[{key:"bitsAvailable",get:function(){return this._bitsAvailable}},{key:"_loadWord",value:function(){var e=this._data.byteLength-this._bytesAvailable,t=Math.min(4,this._bytesAvailable);if(0===t)throw new Error("No bytes available");var a=new Uint8Array(4);a.set(this._data.subarray(e,e+t)),this._word=new DataView(a.buffer).getUint32(0),this._bitsAvailable=8*t,this._bytesAvailable-=t}},{key:"skipBits",value:function(e){if(this._bitsAvailable>e)this._word<<=e,this._bitsAvailable-=e;else{e-=this._bitsAvailable;var t=Math.floor(e/8);e-=8*t,this._bytesAvailable-=t,this._loadWord(),this._word<<=e,this._bitsAvailable-=e}}},{key:"readBits",value:function(e){if(e>32)throw new Error("Cannot read more than 32 bits");var t=Math.min(this._bitsAvailable,e),a=this._word>>>32-t;return this._bitsAvailable-=t,this._bitsAvailable>0?this._word<<=t:this._bytesAvailable>0&&this._loadWord(),(t=e-t)>0&&this._bitsAvailable?a<<t|this.readBits(t):a}},{key:"skipLZ",value:function(){var e;for(e=0;e<this._bitsAvailable;++e)if(0!=(this._word&2147483648>>>e))return this._word<<=e,this._bitsAvailable-=e,e;return this._loadWord(),e+this.skipLZ()}},{key:"skipUEG",value:function(){this.skipBits(1+this.skipLZ())}},{key:"readUEG",value:function(){var e=this.skipLZ();return this.readBits(e+1)-1}},{key:"readEG",value:function(){var e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}},{key:"readBool",value:function(){return 1===this.readBits(1)}},{key:"readUByte",value:function(){return this.readBits(8)}},{key:"skipScalingList",value:function(e){for(var t=8,a=8,i=0;i<e;i++)0!==a&&(a=(t+this.readEG()+256)%256),t=0===a?t:a}}]),t}(),K=function(){function t(){e(this,t)}return a(t,null,[{key:"parseAVCDecoderConfigurationRecord",value:function(e){if(!(e.length<7)){for(var a,i,n=1+(3&e[4]),r=[],s=[],o=6,u=31&e[5],c=0;c<u;c++)if(i=e[o]<<8|e[o+1],o+=2,i){var l=e.subarray(o,o+i);o+=i,r.push(l),a||(a=t.parseSPS(j.removeEPB(l)))}var d,f=e[o];o++;for(var h=0;h<f;h++)d=e[o]<<8|e[o+1],o+=2,d&&(s.push(e.subarray(o,o+d)),o+=d);return{sps:a,spsArr:r,ppsArr:s,nalUnitSize:n}}}},{key:"parseSPS",value:function(e){var t=new H(e);t.readUByte();var a=t.readUByte(),i=t.readUByte(),n=t.readUByte();t.skipUEG();var r=420;if(100===a||110===a||122===a||244===a||44===a||83===a||86===a||118===a||128===a||138===a||144===a){var s=t.readUEG();if(s<=3&&(r=[0,420,422,444][s]),3===s&&t.skipBits(1),t.skipUEG(),t.skipUEG(),t.skipBits(1),t.readBool())for(var o=3!==s?8:12,u=0;u<o;u++)t.readBool()&&(u<6?t.skipScalingList(16):t.skipScalingList(64))}t.skipUEG();var c=t.readUEG();if(0===c)t.readUEG();else if(1===c){t.skipBits(1),t.skipUEG(),t.skipUEG();for(var l=t.readUEG(),d=0;d<l;d++)t.skipUEG()}t.skipUEG(),t.skipBits(1);var f=t.readUEG(),h=t.readUEG(),p=t.readBits(1);0===p&&t.skipBits(1),t.skipBits(1);var v,m,y,b,g,k=0,_=0,x=0,w=0;if(t.readBool()&&(k=t.readUEG(),_=t.readUEG(),x=t.readUEG(),w=t.readUEG()),t.readBool()){if(t.readBool())switch(t.readUByte()){case 1:v=[1,1];break;case 2:v=[12,11];break;case 3:v=[10,11];break;case 4:v=[16,11];break;case 5:v=[40,33];break;case 6:v=[24,11];break;case 7:v=[20,11];break;case 8:v=[32,11];break;case 9:v=[80,33];break;case 10:v=[18,11];break;case 11:v=[15,11];break;case 12:v=[64,33];break;case 13:v=[160,99];break;case 14:v=[4,3];break;case 15:v=[3,2];break;case 16:v=[2,1];break;case 255:v=[t.readUByte()<<8|t.readUByte(),t.readUByte()<<8|t.readUByte()]}if(t.readBool()&&t.readBool(),t.readBool()&&(t.readBits(4),t.readBool()&&t.readBits(24)),t.readBool()&&(t.readUEG(),t.readUEG()),t.readBool()){var A=t.readBits(32),D=t.readBits(32);m=t.readBool(),g=(y=D)/(b=2*A)}}return{codec:N(e.subarray(1,4)),profileIdc:a,profileCompatibility:i,levelIdc:n,chromaFormat:r,width:Math.ceil(16*(f+1)-2*(k+_)),height:(2-p)*(h+1)*16-(p?2:4)*(x+w),sarRatio:v,fpsNum:y,fpsDen:b,fps:g,fixedFrame:m}}}]),t}(),q=function(){function t(){e(this,t)}return a(t,null,[{key:"parseHEVCDecoderConfigurationRecord",value:function(e){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!(e.length<23)){a=a||{};for(var i,n,r,s,o,u=1+(3&e[21]),c=[],l=[],d=[],f=23,h=e[22],p=0;p<h;p++){r=63&e[f],s=e[f+1]<<8|e[f+2],f+=3;for(var v=0;v<s;v++)if(o=e[f]<<8|e[f+1],f+=2,o){switch(r){case 32:var m=e.subarray(f,f+o);i||(i=t.parseVPS(j.removeEPB(m),a)),d.push(m);break;case 33:var y=e.subarray(f,f+o);n||(n=t.parseSPS(j.removeEPB(y),a)),c.push(y);break;case 34:l.push(e.subarray(f,f+o))}f+=o}}return{hvcC:a,sps:n,spsArr:c,ppsArr:l,vpsArr:d,nalUnitSize:u}}}},{key:"parseVPS",value:function(e,a){a=a||{};var i=new H(e);i.readUByte(),i.readUByte(),i.readBits(12);var n=i.readBits(3);return a.numTemporalLayers=Math.max(a.numTemporalLayers||0,n+1),i.readBits(17),t._parseProfileTierLevel(i,n,a),a}},{key:"parseSPS",value:function(e){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};a=a||{};var i=new H(e);i.readUByte(),i.readUByte(),i.readBits(4);var n=i.readBits(3);a.numTemporalLayers=Math.max(n+1,a.numTemporalLayers||0),a.temporalIdNested=i.readBits(1),t._parseProfileTierLevel(i,n,a),i.readUEG();var r=a.chromaFormatIdc=i.readUEG(),s=420;r<=3&&(s=[0,420,422,444][r]);var o=0;3===r&&(o=i.readBits(1));var u,c,l,d,f=i.readUEG(),h=i.readUEG(),p=i.readBits(1);(1===p&&(u=i.readUEG(),c=i.readUEG(),l=i.readUEG(),d=i.readUEG()),a.bitDepthLumaMinus8=i.readUEG(),a.bitDepthChromaMinus8=i.readUEG(),1===p)&&(f-=(1!==r&&2!==r||0!==o?1:2)*(c+u),h-=(1===r&&0===o?2:1)*(d+l));return{codec:"hev1.1.6.L93.B0",width:f,height:h,chromaFormat:s,hvcC:a}}},{key:"_parseProfileTierLevel",value:function(e,t,a){var i=a.generalTierFlag||0;a.generalProfileSpace=e.readBits(2),a.generalTierFlag=Math.max(e.readBits(1),i),a.generalProfileIdc=Math.max(e.readBits(5),a.generalProfileIdc||0),a.generalProfileCompatibilityFlags=e.readBits(32),a.generalConstraintIndicatorFlags=[e.readBits(8),e.readBits(8),e.readBits(8),e.readBits(8),e.readBits(8),e.readBits(8)];var n=e.readBits(8);i<a.generalTierFlag?a.generalLevelIdc=n:a.generalLevelIdc=Math.max(n,a.generalLevelIdc||0);var r=[],s=[];if(t>e.bitsAvailable)throw new Error("maxSubLayersMinus inavlid size ".concat(t));for(var o=0;o<t;o++)r[o]=e.readBits(1),s[o]=e.readBits(1);t>0&&e.readBits(2*(8-t));for(var u=0;u<t;u++)0!==r[u]&&(e.readBits(2),e.readBits(1),e.readBits(5),e.readBits(16),e.readBits(16),e.readBits(4),e.readBits(16),e.readBits(16),e.readBits(12)),0!==s[u]&&e.readBits(8)}}]),t}(),W=9e4,Y=45e4,Z=9e4,Q=function(){function t(a,i,n){e(this,t),this.videoTrack=a,this.audioTrack=i,this.metadataTrack=n,this._baseDts=-1,this._baseDtsInited=!1,this._audioNextPts=void 0,this._videoNextDts=void 0,this._audioTimestampBreak=!1,this._videoTimestampBreak=!1,this._lastAudioExceptionGapDot=0,this._lastAudioExceptionOverlapDot=0,this._lastAudioExceptionLargeGapDot=0}return a(t,[{key:"fix",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,a=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];t=Math.round(9e4*t);var n=this.videoTrack,r=this.audioTrack,s=n.samples,o=r.samples;if(s.length||o.length){var u=s[0],c=o[0],l=0;if(s.length&&o.length&&(l=u.dts-c.pts),this._baseDtsInited||this._calculateBaseDts(this.audioTrack,this.videoTrack),a&&(this._calculateBaseDts(this.audioTrack,this.videoTrack),this._baseDts-=t),!i){this._videoNextDts=l>0?t+l:t,this._audioNextPts=l>0?t:t-l;var d=u?u.dts-this._baseDts-this._videoNextDts:0,f=c?c.pts-this._baseDts-this._audioNextPts:0;Math.abs(d||f)>Z&&(this._calculateBaseDts(this.audioTrack,this.videoTrack),this._baseDts-=t)}if(this._resetBaseDtsWhenStreamBreaked(),this._fixAudio(r),this._fixVideo(n),this.metadataTrack.exist()){var h=this.metadataTrack.timescale;this.metadataTrack.seiSamples.forEach((function(t){t.pts=t.originPts-e._baseDts,t.time=Math.max(0,t.pts)/h}))}n.samples.length&&(n.baseMediaDecodeTime=n.samples[0].dts),r.samples.length&&(r.baseMediaDecodeTime=r.samples[0].pts*r.timescale/9e4)}}},{key:"_fixVideo",value:function(e){var t=this,a=e.samples;if(a.length){if(a.forEach((function(e){e.dts-=t._baseDts,e.pts-=t._baseDts})),void 0===this._videoNextDts){var i=a[0];this._videoNextDts=i.dts}var n,r,s=a.length,o=0,u=a[0],c=a[1],l=this._videoNextDts-u.dts;if(Math.abs(l)>45e3)if(e.warnings.push({type:_.LARGE_VIDEO_GAP_BETWEEN_CHUNK,nextDts:this._videoNextDts/90,firstSampleDts:u.dts/90,nextSampleDts:((null===(n=a[1])||void 0===n?void 0:n.dts)||0)/90,sampleDuration:l/90}),u.dts+=l,u.pts+=l,c&&Math.abs(c.dts-u.dts)>Z)this._videoTimestampBreak=!0,a.forEach((function(e,t){0!==t&&(e.dts+=l,e.pts+=l)}));else for(var d=1;d<s-1;d++){var f,h=null===(f=a[d])||void 0===f?void 0:f.dts,p=a[d-1].dts;h&&h-p<0&&(a[d].dts+=l,a[d].pts+=l)}if(e.fpsNum&&e.fpsDen)r=e.timescale*(e.fpsDen/e.fpsNum);else{var v=e.samples[0],m=e.samples[1];r=1===s?9e3:Math.floor(m.dts-v.dts)}for(var y=0;y<s;y++){var b=a[y].dts,g=a[y+1];if((o=y<s-1?g.dts-b:a[y-1]?Math.min(b-a[y-1].dts,r):r)>Z||o<0){this._videoTimestampBreak=!0,o=this._audioTimestampBreak?r:Math.max(o,2700);var k=this._audioNextPts||0;g&&g.dts>k&&(o=r),e.warnings.push({type:_.LARGE_VIDEO_GAP,time:b/e.timescale,dts:b,originDts:a[y].originDts,nextDts:this._videoNextDts,sampleDuration:o,refSampleDuration:r})}a[y].duration=o,this._videoNextDts+=o}}}},{key:"_fixAudio",value:function(e){var t=this,a=e.samples;a.length&&(a.forEach((function(e){e.pts-=t._baseDts,e.dts=e.pts})),this._doFixAudioInternal(e,a,9e4))}},{key:"_calculateBaseDts",value:function(e,t){var a=e.samples,i=t.samples;if(!a.length&&!i.length)return!1;var n=1/0,r=1/0;a.length&&(e.baseDts=n=a[0].pts),i.length&&(t.baseDts=r=i[0].dts),this._baseDts=Math.min(n,r);var s=r-n;return Number.isFinite(s)&&Math.abs(s)>45e3&&t.warnings.push({type:_.LARGE_AV_SHIFT,videoBaseDts:r,audioBasePts:n,baseDts:this._baseDts,delta:s}),this._baseDtsInited=!0,!0}},{key:"_resetBaseDtsWhenStreamBreaked",value:function(){if(this._baseDtsInited&&this._videoTimestampBreak&&this._audioTimestampBreak){if(!this._calculateBaseDts(this.audioTrack,this.videoTrack))return;this._baseDts-=Math.min(this._audioNextPts,this._videoNextDts),this._audioLastSample=null,this._videoLastSample=null,this._videoTimestampBreak=!1,this._audioTimestampBreak=!1}}},{key:"_doFixAudioInternal",value:function(e,t,a){e.sampleDuration||(e.sampleDuration=R.getFrameDuration(e.timescale,a));var i=e.sampleDuration;if(void 0===this._audioNextPts){var n=t[0];this._audioNextPts=n.pts}for(var r=0;r<t.length;r++){var s=this._audioNextPts,o=t[r],u=o.pts-s;if(!this._audioTimestampBreak&&u>=3*i&&u<=W&&!P){var c=R.getSilentFrame(e.codec,e.channelCount)||t[0].data.subarray(),l=Math.floor(u/i);Math.abs(o.pts-this._lastAudioExceptionGapDot)>Y&&(this._lastAudioExceptionGapDot=o.pts),e.warnings.push({type:_.AUDIO_FILLED,pts:o.pts,originPts:o.originPts,count:l,nextPts:s,refSampleDuration:i});for(var d=0;d<l;d++){var f=new D(Math.floor(s),c);f.originPts=Math.floor(this._baseDts+s),t.splice(r,0,f),this._audioNextPts+=i,r++}r--}else u<=-3*i&&u>=-9e4?(Math.abs(o.pts-this._lastAudioExceptionOverlapDot)>Y&&(this._lastAudioExceptionOverlapDot=o.pts,e.warnings.push({type:_.AUDIO_DROPPED,pts:o.pts,originPts:o.originPts,nextPts:s,refSampleDuration:i})),t.splice(r,1),r--):(Math.abs(u)>=W&&(this._audioTimestampBreak=!0,Math.abs(o.pts-this._lastAudioExceptionLargeGapDot)>Y&&(this._lastAudioExceptionLargeGapDot=o.pts,e.warnings.push({type:_.LARGE_AUDIO_GAP,time:o.pts/1e3,pts:o.pts,originPts:o.originPts,nextPts:s,sampleDuration:u,refSampleDuration:i}))),o.dts=o.pts=s,this._audioNextPts+=i)}}}]),t}(),$=new B("TsDemuxer"),J=function(){function t(a,n,r){e(this,t),i(this,"_pmtId",-1),i(this,"_remainingPacketData",null),i(this,"_videoPesData",[]),i(this,"_audioPesData",[]),i(this,"_gopId",0),this.videoTrack=a||new x,this.audioTrack=n||new w,this.metadataTrack=r||new T,this._fixer=new Q(this.videoTrack,this.audioTrack,this.metadataTrack)}return a(t,[{key:"demux",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=this.audioTrack,n=this.videoTrack,r=this.metadataTrack;t&&(this._pmtId=-1,n.reset(),i.reset(),r.reset()),!a||t?(this._remainingPacketData=null,this._videoPesData=[],this._audioPesData=[]):(n.samples=[],i.samples=[],r.seiSamples=[],n.warnings=[],i.warnings=[],this._remainingPacketData&&(e=z(this._remainingPacketData,e),this._remainingPacketData=null));var s=e.length,o=s%188;o&&(this._remainingPacketData=e.subarray(s-o),s-=o);for(var u=n.pid,c=i.pid,l=0;l<s;l+=188){if(71!==e[l])throw new Error("TS packet did not start with 0x47");var d=!!(64&e[l+1]),f=((31&e[l+1])<<8)+e[l+2],h=void 0;if((48&e[l+3])>>4>1){if((h=l+5+e[l+4])===l+188)continue}else h=l+4;switch(f){case 0:d&&(h+=e[h]+1),this._pmtId=(31&e[h+10])<<8|e[h+11];break;case this._pmtId:d&&(h+=e[h]+1);var p=h+3+((15&e[h+1])<<8|e[h+2])-4;for(h+=12+((15&e[h+10])<<8|e[h+11]);h<p;){var v=(31&e[h+1])<<8|e[h+2];switch(e[h]){case 15:i.pid=c=v;break;case 27:if(-1!==u)break;n.codecType=m,n.pid=u=v;break;case 36:if(-1!==u)break;n.codecType=y,n.pid=u=v;break;default:$.warn("Unsupported stream. type: ".concat(e[h],", pid: ").concat(v))}h+=5+((15&e[h+3])<<8|e[h+4])}break;case u:d&&this._videoPesData.length&&this._parseVideoData(),this._videoPesData.push(e.subarray(h,l+188));break;case c:d&&this._audioPesData.length&&this._parseAudioData(),this._audioPesData.push(e.subarray(h,l+188));break;case 17:case 8191:break;default:$.warn("Unknown pid: ".concat(f))}}return this._parseVideoData(),this._parseAudioData(),i.formatTimescale=n.formatTimescale=n.timescale=r.timescale=9e4,i.timescale=i.sampleRate||0,{videoTrack:n,audioTrack:i,metadataTrack:r}}},{key:"fix",value:function(e,t,a){return this._fixer.fix(e,t,a),{videoTrack:this.videoTrack,audioTrack:this.audioTrack,metadataTrack:this.metadataTrack}}},{key:"demuxAndFix",value:function(e,t,a,i){return this.demux(e,t,a),this.fix(i,t,a)}},{key:"_parseVideoData",value:function(){if(this._videoPesData.length){var e=t._parsePES(z.apply(void 0,c(this._videoPesData)));if(e){var a=j.parseAnnexB(e.data);a?this._createVideoSample(a,e.pts,e.dts):$.warn("Cannot parse avc units",e),this._videoPesData=[]}else $.warn("Cannot parse video pes",this._videoPesData)}}},{key:"_createVideoSample",value:function(e,t,a){var i=this;if(e.length){var n=this.videoTrack,r=n.codecType===y,s=new A(t,a);e.forEach((function(e){var a=r?e[0]>>>1&63:31&e[0];switch(a){case 5:case 16:case 17:case 18:case 19:case 20:case 21:case 22:case 23:if(!r&&5!==a||r&&5===a)break;s.setToKeyframe(),i._gopId++;break;case 6:case 39:case 40:if(!r&&6!==a||r&&6===a)break;return void i.metadataTrack.seiSamples.push(new S(j.parseSEI(j.removeEPB(e),r),t));case 32:if(!r)break;if(!n.vps.length){var o=q.parseVPS(j.removeEPB(e),n.hvcC);n.hvcC=n.hvcC||o,n.vps=[e]}break;case 7:case 33:if(!r&&7!==a||r&&7===a)break;if(!n.sps.length){var u=j.removeEPB(e),c=r?q.parseSPS(u,n.hvcC):K.parseSPS(u);n.sps=[e],n.hvcC=n.hvcC||c.hvcC,n.codec=c.codec,n.width=c.width,n.height=c.height,n.sarRatio=c.sarRatio,n.fpsNum=c.fpsNum,n.fpsDen=c.fpsDen}break;case 8:case 34:if(!r&&8!==a||r&&8===a)break;n.pps.length||(n.pps=[e])}s.units.push(e)})),s.gopId=this._gopId,this._pushVideoSample(n,s)}}},{key:"_pushVideoSample",value:function(e,t){if(t.units.length)if(null===t.pts||void 0===t.pts){$.warn("Video sample no pts",t);var a=e.samples[e.samples.length-1];a?(t.pts=a.pts,t.dts=a.dts):$.warn("Drop video sample",t)}else e.samples.push(t)}},{key:"_parseAudioData",value:function(){if(this._audioPesData.length){var e=t._parsePES(z.apply(void 0,c(this._audioPesData)));e?(this._parseAacData(e),this._audioPesData=[]):$.warn("Cannot parse audio pes",this._audioPesData)}}},{key:"_parseAacData",value:function(e){var t=this.audioTrack,a=e.pts;if(null==a){if($.warn("AAC pes not pts",t),!t.samples.length||!t.sampleRate)return;a=t.samples[t.samples.length-1].pts+R.getFrameDuration(t.sampleRate)}var i,n=R.parseADTS(e.data,a);n?(t.codec=n.codec,t.channelCount=n.channelCount,t.sampleRate=n.sampleRate,t.objectType=n.objectType,t.sampleRateIndex=n.samplingFrequencyIndex,t.config=n.config,(i=t.samples).push.apply(i,c(n.frames.map((function(e){return new D(e.pts,e.data)})))),n.skip&&$.warn("Skip aac adts ".concat(n.skip," bits")),n.remaining&&$.warn("Remaining aac adts ".concat(n.remaining," bits"))):$.warn("Cannot parse aac adts",e)}}],[{key:"probe",value:function(e){return!!e.length&&(71===e[0]&&71===e[188]&&71===e[376])}},{key:"_parsePES",value:function(e){var t=e[8];if(!(null==t||e.length<t+9)&&1===(e[0]<<16|e[1]<<8|e[2])){var a=(e[4]<<8)+e[5];if(!(a&&a>e.length-6)){var i,n,r=e[7];return 192&r&&(i=536870912*(14&e[9])+4194304*(255&e[10])+16384*(254&e[11])+128*(255&e[12])+(254&e[13])/2,64&r?i-(n=536870912*(14&e[14])+4194304*(255&e[15])+16384*(254&e[16])+128*(255&e[17])+(254&e[18])/2)>54e5&&(i=n):n=i),{data:e.subarray(9+t),pts:i,dts:n}}}}}]),t}(),X=function(){function t(){e(this,t)}return a(t,null,[{key:"findBox",value:function(e,a){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=[];if(!e)return n;for(var r=0,s="",o=0;e.length>7;){if(r=O(e),s=String.fromCharCode.apply(null,e.subarray(4,8)),o=8,1===r?(r=G(e,8),o+=8):r||(r=e.length),!a[0]||s===a[0]){var u=e.subarray(0,r);if(!(a.length<2))return t.findBox(u.subarray(o),a.slice(1),i+o);n.push({start:i,size:r,headerSize:o,type:s,data:u})}i+=r,e=e.subarray(r)}return n}},{key:"tfhd",value:function(e){return ie(e,!0,(function(e,t){e.trackId=O(t);var a=4,i=1&e.flags,n=2&e.flags,r=8&e.flags,s=16&e.flags,o=32&e.flags;i&&(a+=4,e.baseDataOffset=O(t,a),a+=4),n&&(e.sampleDescriptionIndex=O(t,a),a+=4),r&&(e.defaultSampleDuration=O(t,a),a+=4),s&&(e.defaultSampleSize=O(t,a),a+=4),o&&(e.defaultSampleFlags=O(t,a))}))}},{key:"sidx",value:function(e){return ie(e,!0,(function(e,t){var a=0;e.reference_ID=O(t,a),a+=4,e.timescale=O(t,a),a+=4,0===e.version?(e.earliest_presentation_time=O(t,a),a+=4,e.first_offset=O(t,a),a+=4):(e.earliest_presentation_time=G(t,a),a+=8,e.first_offset=G(t,a),a+=8),a+=2,e.references=[];var i=V(t,a);a+=2;for(var n=0;n<i;n++){var r={};e.references.push(r);var s=O(t,a);a+=4,r.reference_type=s>>31&1,r.referenced_size=2147483647&s,r.subsegment_duration=O(t,a),s=O(t,a+=4),a+=4,r.starts_with_SAP=s>>31&1,r.SAP_type=s>>28&7,r.SAP_delta_time=268435455&s}}))}},{key:"moov",value:function(e){return ie(e,!1,(function(e,a,i){e.mvhd=t.mvhd(t.findBox(a,["mvhd"],i)[0]),e.trak=t.findBox(a,["trak"],i).map((function(e){return t.trak(e)})),e.pssh=t.pssh(t.findBox(a,["pssh"],i)[0])}))}},{key:"mvhd",value:function(e){return ie(e,!0,(function(e,t){var a=0;1===e.version?(e.timescale=O(t,16),e.duration=G(t,20),a+=28):(e.timescale=O(t,8),e.duration=O(t,12),a+=16),e.nextTrackId=O(t,a+76)}))}},{key:"trak",value:function(e){return ie(e,!1,(function(e,a,i){e.tkhd=t.tkhd(t.findBox(a,["tkhd"],i)[0]),e.mdia=t.mdia(t.findBox(a,["mdia"],i)[0])}))}},{key:"tkhd",value:function(e){return ie(e,!0,(function(e,t){var a=0;1===e.version?(e.trackId=O(t,16),e.duration=G(t,24),a+=32):(e.trackId=O(t,8),e.duration=O(t,16),a+=20),e.width=O(t,a+52),e.height=O(t,a+56)}))}},{key:"mdia",value:function(e){return ie(e,!1,(function(e,a,i){e.mdhd=t.mdhd(t.findBox(a,["mdhd"],i)[0]),e.hdlr=t.hdlr(t.findBox(a,["hdlr"],i)[0]),e.minf=t.minf(t.findBox(a,["minf"],i)[0])}))}},{key:"mdhd",value:function(e){return ie(e,!0,(function(e,t){var a=0;1===e.version?(e.timescale=O(t,16),e.duration=G(t,20),a+=28):(e.timescale=O(t,8),e.duration=O(t,12),a+=16);var i=V(t,a);e.language=String.fromCharCode(96+(i>>10&31),96+(i>>5&31),96+(31&i))}))}},{key:"hdlr",value:function(e){return ie(e,!0,(function(e,t){0===e.version&&(e.handlerType=String.fromCharCode.apply(null,t.subarray(4,8)))}))}},{key:"minf",value:function(e){return ie(e,!1,(function(e,a,i){e.vmhd=t.vmhd(t.findBox(a,["vmhd"],i)[0]),e.smhd=t.smhd(t.findBox(a,["smhd"],i)[0]),e.stbl=t.stbl(t.findBox(a,["stbl"],i)[0])}))}},{key:"vmhd",value:function(e){return ie(e,!0,(function(e,t){e.graphicsmode=V(t),e.opcolor=[V(t,2),V(t,4),V(t,6)]}))}},{key:"smhd",value:function(e){return ie(e,!0,(function(e,t){e.balance=V(t)}))}},{key:"stbl",value:function(e){return ie(e,!1,(function(e,a,i){var n,r,s;e.stsd=t.stsd(t.findBox(a,["stsd"],i)[0]),e.stts=t.stts(t.findBox(a,["stts"],i)[0]),e.ctts=t.ctts(t.findBox(a,["ctts"],i)[0]),e.stsc=t.stsc(t.findBox(a,["stsc"],i)[0]),e.stsz=t.stsz(t.findBox(a,["stsz"],i)[0]),e.stco=t.stco(t.findBox(a,["stco"],i)[0]),e.stco||(e.co64=t.co64(t.findBox(a,["co64"],i)[0]),e.stco=e.co64);var o=null===(n=e.stsd.entries[0])||void 0===n||null===(r=n.sinf)||void 0===r||null===(s=r.schi)||void 0===s?void 0:s.tenc.default_IV_size;e.stss=t.stss(t.findBox(a,["stss"],i)[0]),e.senc=t.senc(t.findBox(a,["senc"],i)[0],o)}))}},{key:"senc",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8;return ie(e,!0,(function(e,a){var i=0,n=O(a,i);i+=4,e.samples=[];for(var r=0;r<n;r++){for(var s={InitializationVector:[]},o=0;o<t;o++)s.InitializationVector[o]=a[i+o];if(i+=t,2&e.flags){s.subsamples=[];var u=V(a,i);i+=2;for(var c=0;c<u;c++){var l={};l.BytesOfClearData=V(a,i),i+=2,l.BytesOfProtectedData=O(a,i),i+=4,s.subsamples.push(l)}}e.samples.push(s)}}))}},{key:"pssh",value:function(e){return ie(e,!0,(function(e,t){for(var a=[],i=[],n=0,r=0;r<16;r++)i.push(ne(t[n+r]));if(n+=16,e.version>0){var s=O(t,n);n+=4;for(var o=0;o<(""+s).length;o++)for(var u=0;u<16;u++){var c=t[n];n+=1,a.push(ne(c))}}var l=O(t,n);e.data_size=l,n+=4,e.kid=a,e.system_id=i,e.buffer=t}))}},{key:"stsd",value:function(e){return ie(e,!0,(function(e,a,i){e.entryCount=O(a),e.entries=t.findBox(a.subarray(4),[],i+4).map((function(e){switch(e.type){case"avc1":case"avc2":case"avc3":case"avc4":return t.avc1(e);case"hvc1":case"hev1":return t.hvc1(e);case"mp4a":return t.mp4a(e);case"alaw":case"ulaw":return t.alaw(e);case"enca":return ie(e,!1,(function(e,a,i){e.channelCount=V(a,16),e.samplesize=V(a,18),e.sampleRate=O(a,24)/65536,a=a.subarray(28),e.sinf=t.sinf(t.findBox(a,["sinf"],i)[0]),e.esds=t.esds(t.findBox(a,["esds"],i)[0])}));case"encv":return ie(e,!1,(function(e,a,i){e.width=V(a,24),e.height=V(a,26),e.horizresolution=O(a,28),e.vertresolution=O(a,32),a=a.subarray(78),e.sinf=t.sinf(t.findBox(a,["sinf"],i)[0]),e.avcC=t.avcC(t.findBox(a,["avcC"],i)[0]),e.hvcC=t.hvcC(t.findBox(a,["hvcC"],i)[0]),e.pasp=t.pasp(t.findBox(a,["pasp"],i)[0])}))}})).filter(Boolean)}))}},{key:"tenc",value:function(e){return ie(e,!1,(function(e,t){var a=6;e.default_IsEncrypted=t[a],a+=1,e.default_IV_size=t[a],a+=1,e.default_KID=[];for(var i=0;i<16;i++)e.default_KID.push(ne(t[a])),a+=1}))}},{key:"schi",value:function(e){return ie(e,!1,(function(e,a,i){e.tenc=t.tenc(t.findBox(a,["tenc"],i)[0])}))}},{key:"sinf",value:function(e){return ie(e,!1,(function(e,a,i){e.schi=t.schi(t.findBox(a,["schi"],i)[0]),e.frma=t.frma(t.findBox(a,["frma"],i)[0])}))}},{key:"frma",value:function(e){return ie(e,!1,(function(e,t){e.data_format="";for(var a=0;a<4;a++)e.data_format+=String.fromCharCode(t[a])}))}},{key:"avc1",value:function(e){return ie(e,!1,(function(e,a,i){var n=te(e,a),r=a.subarray(n);i+=n,e.avcC=t.avcC(t.findBox(r,["avcC"],i)[0]),e.pasp=t.pasp(t.findBox(r,["pasp"],i)[0])}))}},{key:"avcC",value:function(e){return ie(e,!1,(function(e,t){e.configurationVersion=t[0],e.AVCProfileIndication=t[1],e.profileCompatibility=t[2],e.AVCLevelIndication=t[3],e.codec=N([t[1],t[2],t[3]]),e.lengthSizeMinusOne=3&t[4],e.spsLength=31&t[5],e.sps=[];for(var a=6,i=0;i<e.spsLength;i++){var n=V(t,a);a+=2,e.sps.push(t.subarray(a,a+n)),a+=n}e.ppsLength=t[a],a+=1,e.pps=[];for(var r=0;r<e.ppsLength;r++){var s=V(t,a);a+=2,e.pps.push(t.subarray(a,a+=s)),a+=s}}))}},{key:"hvc1",value:function(e){return ie(e,!1,(function(e,a,i){var n=te(e,a),r=a.subarray(n);i+=n,e.hvcC=t.hvcC(t.findBox(r,["hvcC"],i)[0]),e.pasp=t.pasp(t.findBox(r,["pasp"],i)[0])}))}},{key:"hvcC",value:function(e){return ie(e,!1,(function(t,a){t.data=e.data,t.codec="hev1.1.6.L93.B0",t.configurationVersion=a[0];var i=a[1];t.generalProfileSpace=i>>6,t.generalTierFlag=(32&i)>>5,t.generalProfileIdc=31&i,t.generalProfileCompatibility=O(a,2),t.generalConstraintIndicatorFlags=a.subarray(6,12),t.generalLevelIdc=a[12],t.avgFrameRate=V(a,19),t.numOfArrays=a[22],t.vps=[],t.sps=[],t.pps=[];for(var n=23,r=0,s=0,o=0,u=0;u<t.numOfArrays;u++){r=63&a[n],s=V(a,n+1),n+=3;for(var c,l=[],d=0;d<s;d++)o=V(a,n),n+=2,l.push(a.subarray(n,n+o)),n+=o;if(32===r)(c=t.vps).push.apply(c,l);else if(33===r){var f;(f=t.sps).push.apply(f,l)}else if(34===r){var h;(h=t.pps).push.apply(h,l)}}}))}},{key:"pasp",value:function(e){return ie(e,!1,(function(e,t){e.hSpacing=O(t),e.vSpacing=O(t,4)}))}},{key:"mp4a",value:function(e){return ie(e,!1,(function(e,a,i){var n=ae(e,a);e.esds=t.esds(t.findBox(a.subarray(n),["esds"],i+n)[0])}))}},{key:"esds",value:function(e){return ie(e,!0,(function(e,t){e.codec="mp4a.";for(var a=0,i=0,n=0,r=0;t.length;){for(r=t[a=0],i=t[a+1],a+=2;128&i;)n=(127&i)<<7,i=t[a],a+=1;if(n+=127&i,3===r)t=t.subarray(a+3);else{if(4!==r){if(5===r){var s=e.config=t.subarray(a,a+n),o=(248&s[0])>>3;return 31===o&&s.length>=2&&(o=32+((7&s[0])<<3)+((224&s[1])>>5)),e.objectType=o,e.codec+=o.toString(16),void("."===e.codec[e.codec.length-1]&&(e.codec=e.codec.substring(0,e.codec.length-1)))}return void("."===e.codec[e.codec.length-1]&&(e.codec=e.codec.substring(0,e.codec.length-1)))}e.codec+=(t[a].toString(16)+".").padStart(3,"0"),t=t.subarray(a+13)}}}))}},{key:"alaw",value:function(e){return ie(e,!1,(function(e,t){ae(e,t)}))}},{key:"stts",value:function(e){return ie(e,!0,(function(e,t){for(var a=O(t),i=[],n=4,r=0;r<a;r++)i.push({count:O(t,n),delta:O(t,n+4)}),n+=8;e.entryCount=a,e.entries=i}))}},{key:"ctts",value:function(e){return ie(e,!0,(function(e,t){var a=O(t),i=[],n=4;if(1===e.version)for(var r=0;r<a;r++)i.push({count:O(t,n),offset:O(t,n+4)}),n+=8;else for(var s=0;s<a;s++)i.push({count:O(t,n),offset:-(1+~O(t,n+4))}),n+=8;e.entryCount=a,e.entries=i}))}},{key:"stsc",value:function(e){return ie(e,!0,(function(e,t){for(var a=O(t),i=[],n=4,r=0;r<a;r++)i.push({firstChunk:O(t,n),samplesPerChunk:O(t,n+4),sampleDescriptionIndex:O(t,n+8)}),n+=12;e.entryCount=a,e.entries=i}))}},{key:"stsz",value:function(e){return ie(e,!0,(function(e,t){var a=O(t),i=O(t,4),n=[];if(!a)for(var r=8,s=0;s<i;s++)n.push(O(t,r)),r+=4;e.sampleSize=a,e.sampleCount=i,e.entrySizes=n}))}},{key:"stco",value:function(e){return ie(e,!0,(function(e,t){for(var a=O(t),i=[],n=4,r=0;r<a;r++)i.push(O(t,n)),n+=4;e.entryCount=a,e.entries=i}))}},{key:"co64",value:function(e){return ie(e,!0,(function(e,t){for(var a=O(t),i=[],n=4,r=0;r<a;r++)i.push(G(t,n)),n+=8;e.entryCount=a,e.entries=i}))}},{key:"stss",value:function(e){return ie(e,!0,(function(e,t){for(var a=O(t),i=[],n=4,r=0;r<a;r++)i.push(O(t,n)),n+=4;e.entryCount=a,e.entries=i}))}},{key:"moof",value:function(e){return ie(e,!1,(function(e,a,i){e.mfhd=t.mfhd(t.findBox(a,["mfhd"],i)[0]),e.traf=t.findBox(a,["traf"],i).map((function(e){return t.traf(e)}))}))}},{key:"mfhd",value:function(e){return ie(e,!0,(function(e,t){e.sequenceNumber=O(t)}))}},{key:"traf",value:function(e){return ie(e,!1,(function(e,a,i){e.tfhd=t.tfhd(t.findBox(a,["tfhd"],i)[0]),e.tfdt=t.tfdt(t.findBox(a,["tfdt"],i)[0]),e.trun=t.trun(t.findBox(a,["trun"],i)[0])}))}},{key:"trun",value:function(e){return ie(e,!0,(function(e,t){var a=e.version,i=e.flags,n=t.length,r=e.sampleCount=O(t),s=4;if(n>s&&1&i&&(e.dataOffset=-(1+~O(t,s)),s+=4),n>s&&4&i&&(e.firstSampleFlags=O(t,s),s+=4),e.samples=[],n>s)for(var o,u=0;u<r;u++)o={},256&i&&(o.duration=O(t,s),s+=4),512&i&&(o.size=O(t,s),s+=4),1024&i&&(o.flags=O(t,s),s+=4),2048&i&&(o.cts=a?-(1+~O(t,s+4)):O(t,s),s+=4),e.samples.push(o)}))}},{key:"tfdt",value:function(e){return ie(e,!0,(function(e,t){1===e.version?e.baseMediaDecodeTime=G(t):e.baseMediaDecodeTime=O(t)}))}},{key:"probe",value:function(e){return!!t.findBox(e,["ftyp"])}},{key:"parseSampleFlags",value:function(e){return{isLeading:(12&e[0])>>>2,dependsOn:3&e[0],isDependedOn:(192&e[1])>>>6,hasRedundancy:(48&e[1])>>>4,paddingValue:(14&e[1])>>>1,isNonSyncSample:1&e[1],degradationPriority:e[2]<<8|e[3]}}},{key:"moovToTrack",value:function(e,t,a){var i,n,r=e.trak;if(r&&r.length){var s=r.find((function(e){var t,a;return"vide"===(null===(t=e.mdia)||void 0===t||null===(a=t.hdlr)||void 0===a?void 0:a.handlerType)})),o=r.find((function(e){var t,a;return"soun"===(null===(t=e.mdia)||void 0===t||null===(a=t.hdlr)||void 0===a?void 0:a.handlerType)}));if(s&&t){var u,c,l,d,f,h,p,v=t,m=null===(u=s.tkhd)||void 0===u?void 0:u.trackId;null!=m&&(v.id=s.tkhd.trackId),v.tkhdDuration=s.tkhd.duration,v.mvhdDurtion=e.mvhd.duration,v.mvhdTimecale=e.mvhd.timescale,v.timescale=v.formatTimescale=s.mdia.mdhd.timescale,v.duration=s.mdia.mdhd.duration||v.mvhdDurtion/v.mvhdTimecale*v.timescale;var b,_,x,w,A,D,E,S,T=s.mdia.minf.stbl.stsd.entries[0];if(v.width=T.width,v.height=T.height,T.pasp&&(v.sarRatio=[T.pasp.hSpacing,T.pasp.vSpacing]),T.hvcC)v.codecType=y,v.codec=T.hvcC.codec,v.vps=T.hvcC.vps,v.sps=T.hvcC.sps,v.pps=T.hvcC.pps,v.hvcC=T.hvcC.data;else{if(!T.avcC)throw new Error("unknown video stsd entry");v.codec=T.avcC.codec,v.sps=T.avcC.sps,v.pps=T.avcC.pps}if(v.present=!0,v.ext={},v.ext.stss=null===(c=s.mdia)||void 0===c||null===(l=c.minf)||void 0===l||null===(d=l.stbl)||void 0===d?void 0:d.stss,v.ext.ctts=null===(f=s.mdia)||void 0===f||null===(h=f.minf)||void 0===h||null===(p=h.stbl)||void 0===p?void 0:p.ctts,T&&"encv"===T.type)v.isVideoEncryption=!0,T.default_KID=null===(b=T.sinf)||void 0===b||null===(_=b.schi)||void 0===_?void 0:_.tenc.default_KID,T.default_IsEncrypted=null===(x=T.sinf)||void 0===x||null===(w=x.schi)||void 0===w?void 0:w.tenc.default_IsEncrypted,T.default_IV_size=null===(A=T.sinf)||void 0===A||null===(D=A.schi)||void 0===D?void 0:D.tenc.default_IV_size,v.videoSenc=s.mdia.minf.stbl.senc&&s.mdia.minf.stbl.senc.samples,T.data_format=null===(E=T.sinf)||void 0===E||null===(S=E.frma)||void 0===S?void 0:S.data_format,v.useEME=e.useEME,v.kidValue=e.kidValue,v.pssh=e.pssh,v.encv=T}if(o&&a){var B,U,C,P,I,M,z,L,V,O=a,G=null===(B=o.tkhd)||void 0===B?void 0:B.trackId;null!=G&&(O.id=o.tkhd.trackId),O.tkhdDuration=o.tkhd.duration,O.mvhdDurtion=e.mvhd.duration,O.mvhdTimecale=e.mvhd.timescale,O.timescale=O.formatTimescale=o.mdia.mdhd.timescale,O.duration=o.mdia.mdhd.duration||O.mvhdDurtion/O.mvhdTimecale*O.timescale;var N,F,j,H,K,q,W,Y,Z=o.mdia.minf.stbl.stsd.entries[0];switch(O.sampleSize=Z.sampleSize,O.sampleRate=Z.sampleRate,O.channelCount=Z.channelCount,O.present=!0,Z.type){case"alaw":O.codecType=O.codec=g,O.sampleRate=8e3;break;case"ulaw":O.codecType=O.codec=k,O.sampleRate=8e3;break;default:O.sampleDuration=R.getFrameDuration(O.sampleRate,O.timescale),O.sampleRateIndex=R.getRateIndexByRate(O.sampleRate),O.objectType=(null===(i=Z.esds)||void 0===i?void 0:i.objectType)||2,Z.esds&&(O.config=Array.from(Z.esds.config)),O.codec=(null===(n=Z.esds)||void 0===n?void 0:n.codec)||"mp4a.40.2"}if(O.sampleDuration=R.getFrameDuration(O.sampleRate,O.timescale),O.objectType=(null===(U=Z.esds)||void 0===U?void 0:U.objectType)||2,Z.esds&&(Z.esds.config?O.config=Array.from(Z.esds.config):console.warn("esds config is null")),O.codec=(null===(C=Z.esds)||void 0===C?void 0:C.codec)||"mp4a.40.2",O.sampleRateIndex=R.getRateIndexByRate(O.sampleRate),O.ext={},O.ext.stss=null===(P=o.mdia)||void 0===P||null===(I=P.minf)||void 0===I||null===(M=I.stbl)||void 0===M?void 0:M.stss,O.ext.ctts=null===(z=o.mdia)||void 0===z||null===(L=z.minf)||void 0===L||null===(V=L.stbl)||void 0===V?void 0:V.ctts,O.present=!0,Z&&"enca"===Z.type)O.isAudioEncryption=!0,Z.data_format=null===(N=Z.sinf)||void 0===N||null===(F=N.frma)||void 0===F?void 0:F.data_format,Z.default_KID=null===(j=Z.sinf)||void 0===j||null===(H=j.schi)||void 0===H?void 0:H.tenc.default_KID,Z.default_IsEncrypted=null===(K=Z.sinf)||void 0===K||null===(q=K.schi)||void 0===q?void 0:q.tenc.default_IsEncrypted,Z.default_IV_size=null===(W=Z.sinf)||void 0===W||null===(Y=W.schi)||void 0===Y?void 0:Y.tenc.default_IV_size,O.audioSenc=o.mdia.minf.stbl.senc&&o.mdia.minf.stbl.senc.samples,O.useEME=e.useEME,O.kidValue=e.kidValue,O.enca=Z}if(a&&(a.isVideoEncryption=!!t&&t.isVideoEncryption),t&&(t.isAudioEncryption=!!a&&a.isAudioEncryption),null!=t&&t.encv||null!=a&&a.enca){var Q,$,J=null==t||null===(Q=t.encv)||void 0===Q?void 0:Q.default_KID,X=null==a||null===($=a.enca)||void 0===$?void 0:$.default_KID,ee=J||X?(J||X).join(""):null;t&&(t.kid=ee),a&&(a.kid=ee)}return t&&(t.flags=3841),a&&(a.flags=1793),{videoTrack:t,audioTrack:a}}}},{key:"evaluateDefaultDuration",value:function(e,t,a){var i,n=null==t||null===(i=t.samples)||void 0===i?void 0:i.length;return n?1024*n/t.timescale*e.timescale/a:1024}},{key:"moofToSamples",value:function(e,a,i){var n={};return e.mfhd&&(a&&(a.sequenceNumber=e.mfhd.sequenceNumber),i&&(i.sequenceNumber=e.mfhd.sequenceNumber)),e.traf.forEach((function(e){var r=e.tfhd,s=e.tfdt,o=e.trun;if(r&&o){s&&(a&&a.id===r.trackId&&(a.baseMediaDecodeTime=s.baseMediaDecodeTime),i&&i.id===r.trackId&&(i.baseMediaDecodeTime=s.baseMediaDecodeTime));var u=r.defaultSampleSize||0,c=r.defaultSampleDuration||t.evaluateDefaultDuration(a,i,o.samples.length||o.sampleCount),l=o.dataOffset||0,d=0,f=-1;if(!o.samples.length&&o.sampleCount){n[r.trackId]=[];for(var h=0;h<o.sampleCount;h++)n[r.trackId].push({offset:l,dts:d,duration:c,size:u}),d+=c,l+=u}else n[r.trackId]=o.samples.map((function(e,t){return(e={offset:l,dts:d,pts:d+(e.cts||0),duration:e.duration||c,size:e.size||u,gopId:f,keyframe:0===t||null!==e.flags&&void 0!==e.flags&&(65536&e.flags)>>>0!=65536}).keyframe&&(f++,e.gopId=f),d+=e.duration,l+=e.size,e}))}})),n}},{key:"moovToSamples",value:function(e){var t=e.trak;if(t&&t.length){var a=t.find((function(e){var t,a;return"vide"===(null===(t=e.mdia)||void 0===t||null===(a=t.hdlr)||void 0===a?void 0:a.handlerType)})),i=t.find((function(e){var t,a;return"soun"===(null===(t=e.mdia)||void 0===t||null===(a=t.hdlr)||void 0===a?void 0:a.handlerType)}));if(a||i){var n,r;if(a){var s,o,u=null===(s=a.mdia)||void 0===s||null===(o=s.minf)||void 0===o?void 0:o.stbl;if(!u)return;var c=u.stts,l=u.stsc,d=u.stsz,f=u.stco,h=u.stss,p=u.ctts;if(!(c&&l&&d&&f&&h))return;n=ee(c,l,d,f,p,h)}if(i){var v,m,y,b=null===(v=i.mdia)||void 0===v||null===(m=v.minf)||void 0===m?void 0:m.stbl;if(!b)return;var g=null===(y=i.mdia.mdhd)||void 0===y?void 0:y.timescale,k=b.stts,_=b.stsc,x=b.stsz,w=b.stco;if(!(g&&k&&_&&x&&w))return;r=ee(k,_,x,w)}return{videoSamples:n,audioSamples:r}}}}}]),t}();function ee(e,t,a,i,n,r){var s,o,u,c=[],l=null==n?void 0:n.entries,d=t.entries,f=i.entries,h=a.entrySizes,p=null==r?void 0:r.entries;p&&(s={},p.forEach((function(e){s[e-1]=!0}))),l&&(o=[],l.forEach((function(e){for(var t=e.count,a=e.offset,i=0;i<t;i++)o.push(a)})));var v=-1,m=0,y=0,b=0,g=0,k=0,_=d[0].samplesPerChunk,x=d[1]?d[1].firstChunk-1:1/0;return e.entries.forEach((function(e){for(var t=e.count,i=e.delta,n=0;n<t;n++)u={dts:m,duration:i,size:h[y]||a.sampleSize,offset:f[b]+k,index:y},p&&(u.keyframe=s[y],u.keyframe&&v++,u.gopId=v),o&&y<o.length&&(u.pts=u.dts+o[y]),c.push(u),m+=i,++y<_?k+=u.size:(b++,k=0,b>=x&&(g++,x=d[g+1]?d[g+1].firstChunk-1:1/0),_+=d[g].samplesPerChunk)})),c}function te(e,t){return e.dataReferenceIndex=V(t,6),e.width=V(t,24),e.height=V(t,26),e.horizresolution=O(t,28),e.vertresolution=O(t,32),e.frameCount=V(t,40),e.depth=V(t,74),78}function ae(e,t){return e.dataReferenceIndex=V(t,6),e.channelCount=V(t,16),e.sampleSize=V(t,18),e.sampleRate=O(t,24)/65536,28}function ie(e,t,a){if(e){if(e.size!==e.data.length)throw new Error("box ".concat(e.type," size !== data.length"));var i={start:e.start,size:e.size,headerSize:e.headerSize,type:e.type};return t&&(i.version=e.data[e.headerSize],i.flags=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return(e[t]<<16)+(e[t+1]<<8)+(e[t+2]||0)}(e.data,e.headerSize+1),i.headerSize+=4),a(i,e.data.subarray(i.headerSize),i.start+i.headerSize),i}}var ne=function(){for(var e=[],t=arguments.length,a=new Array(t),i=0;i<t;i++)a[i]=arguments[i];return a.forEach((function(t){e.push(function(e,t,a){for(var i=String(a),n=t>>0,r=Math.ceil(n/i.length),s=[],o=String(e);r--;)s.push(i);return s.join("").substring(0,n-o.length)+o}(Number(t).toString(16),2,0))})),e[0]},re=function(){function t(a,i,n){e(this,t),this.videoTrack=a||new x,this.audioTrack=i||new w,this.metadataTrack=n||new T}return a(t,[{key:"demux",value:function(e,t){var a=this.videoTrack,i=this.audioTrack,n=a.exist(),r=i.exist();if(a.samples=[],i.samples=[],t){if(!r){var s=X.findBox(t,["moov"])[0];if(!s)throw new Error("cannot found moov box");X.moovToTrack(X.moov(s),null,i)}var o=X.findBox(t,["moof"])[0];if(o){var u=X.moofToSamples(X.moof(o),null,i)[i.id],c=i.baseMediaDecodeTime;if(u){var l=o.start;u.map((function(e){e.offset+=l;var a=t.subarray(e.offset,e.offset+e.size);i.samples.push(new D(e.dts+c,a,e.duration))}))}}}if(e){if(!n&&!r){var d=X.findBox(e,["moov"])[0];if(!d)throw new Error("cannot found moov box");X.moovToTrack(X.moov(d),a,i)}var f=X.findBox(e,["moof"])[0];if(f){var h,p=X.moofToSamples(X.moof(f),a,i),v=a.baseMediaDecodeTime,m=i.baseMediaDecodeTime,y=f.start;Object.keys(p).forEach((function(t){a.id==t?p[t].map((function(t){t.offset+=y;var i=new A((t.pts||t.dts)+v,t.dts+v);i.duration=t.duration,i.gopId=t.gopId,t.keyframe&&i.setToKeyframe();var n=e.subarray(t.offset,t.offset+t.size);i.data=n;for(var r=0,s=n.length-1;r<s;)h=O(n,r),r+=4,i.units.push(n.subarray(r,r+h)),r+=h;a.samples.push(i)})):i.id==t&&p[t].map((function(t){t.offset+=y;var a=e.subarray(t.offset,t.offset+t.size);i.samples.push(new D(t.dts+m,a,t.duration))}))}))}}return{videoTrack:a,audioTrack:i,metadataTrack:this.metadataTrack}}},{key:"reset",value:function(){this.videoTrack.reset(),this.audioTrack.reset(),this.metadataTrack.reset()}}],[{key:"probe",value:function(e){return X.probe(e)}}]),t}();var se=function(){function t(){e(this,t),this.buffer=new Uint8Array(0)}return a(t,[{key:"write",value:function(){for(var e=this,t=arguments.length,a=new Array(t),i=0;i<t;i++)a[i]=arguments[i];a.forEach((function(t){t?e.buffer=function(e){for(var t=0,a=arguments.length,i=new Array(a>1?a-1:0),n=1;n<a;n++)i[n-1]=arguments[n];i.forEach((function(e){t+=e.length}));var r=new e(t),s=0;return i.forEach((function(e){r.set(e,s),s+=e.length})),r}(Uint8Array,e.buffer,t):window.console.warn(t)}))}}],[{key:"writeUint16",value:function(e){return new Uint8Array([e>>8&255,255&e])}},{key:"writeUint32",value:function(e){return new Uint8Array([e>>24,e>>16&255,e>>8&255,255&e])}}]),t}(),oe=Math.pow(2,32)-1,ue=function(){function t(){e(this,t)}return a(t,null,[{key:"box",value:function(e){for(var t=arguments.length,a=new Array(t>1?t-1:0),i=1;i<t;i++)a[i-1]=arguments[i];var n=8+(a=a.filter(Boolean)).reduce((function(e,t){return e+t.byteLength}),0),r=new Uint8Array(n);r[0]=n>>24&255,r[1]=n>>16&255,r[2]=n>>8&255,r[3]=255&n,r.set(e,4);var s=8;return a.forEach((function(e){r.set(e,s),s+=e.byteLength})),r}},{key:"ftyp",value:function(e){return e.find((function(e){return e.type===h&&e.codecType===y}))?t.FTYPHEV1:t.FTYPAVC1}},{key:"initSegment",value:function(e){return z(t.ftyp(e),t.moov(e))}},{key:"pssh",value:function(e){var a=new Uint8Array([1,0,0,0].concat([16,119,239,236,192,178,77,2,172,227,60,30,82,226,251,75],[0,0,0,1],F(e.kid),[0,0,0,0]));return t.box(t.types.pssh,a)}},{key:"moov",value:function(e){if(e[0].useEME&&(e[0].encv||e[0].enca)){e[0].pssh||(e[0].pssh={kid:e[0].kid});var a=this.pssh(e[0].pssh);return t.box.apply(t,[t.types.moov,t.mvhd(e[0].mvhdDurtion||e[0].duration,e[0].mvhdTimecale||e[0].timescale),t.mvex(e)].concat(c(e.map((function(e){return t.trak(e)}))),[a]))}return t.box.apply(t,[t.types.moov,t.mvhd(e[0].mvhdDurtion||e[0].duration,e[0].mvhdTimecale||e[0].timescale)].concat(c(e.map((function(e){return t.trak(e)}))),[t.mvex(e)]))}},{key:"mvhd",value:function(e){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:9e4;return t.box(t.types.mvhd,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,a>>24&255,a>>16&255,a>>8&255,255&a,e>>24&255,e>>16&255,e>>8&255,255&e,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]))}},{key:"trak",value:function(e){return t.box(t.types.trak,t.tkhd(e.id,e.tkhdDuration||0,e.width,e.height),t.mdia(e))}},{key:"tkhd",value:function(e,a){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return t.box(t.types.tkhd,new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,e>>24&255,e>>16&255,e>>8&255,255&e,0,0,0,0,a>>24&255,a>>16&255,a>>8&255,255&a,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,i>>8&255,255&i,0,0,n>>8&255,255&n,0,0]))}},{key:"mdia",value:function(e){return t.box(t.types.mdia,t.mdhd(e.duration,e.timescale),t.hdlr(e.type),t.minf(e))}},{key:"mdhd",value:function(e){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:9e4;return t.box(t.types.mdhd,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,a>>24&255,a>>16&255,a>>8&255,255&a,e>>24&255,e>>16&255,e>>8&255,255&e,85,196,0,0]))}},{key:"hdlr",value:function(e){return t.box(t.types.hdlr,t.HDLR_TYPES[e])}},{key:"minf",value:function(e){return t.box(t.types.minf,e.type===h?t.VMHD:t.SMHD,t.DINF,t.stbl(e))}},{key:"stbl",value:function(e){var a=[];return e&&e.ext&&e.ext.stss&&a.push(t.stss(e.ext.stss.entries)),t.box(t.types.stbl,t.stsd(e),t.STTS,a[0],t.STSC,t.STSZ,t.STCO)}},{key:"stsd",value:function(e){var a;return a="audio"===e.type?e.useEME&&e.enca?t.enca(e):t.mp4a(e):e.useEME&&e.encv?t.encv(e):t.avc1hev1(e),t.box(t.types.stsd,new Uint8Array([0,0,0,0,0,0,0,1]),a)}},{key:"enca",value:function(e){var a=e.enca.channelCount,i=e.enca.sampleRate,n=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,a,0,16,0,0,0,0,i>>8&255,255&i,0,0]),r=t.esds(e.config),s=t.sinf(e.enca);return t.box(t.types.enca,n,r,s)}},{key:"encv",value:function(e){var a,i,n=e.sps.length>0?e.sps[0]:[],r=e.pps.length>0?e.pps[0]:[],s=e.width,o=e.height,u=e.sarRatio[0],l=e.sarRatio[1],d=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,s>>8&255,255&s,o>>8&255,255&o,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),f=new Uint8Array((a=(i=[1,n[1],n[2],n[3],255,225,n.length>>>8&255,255&n.length]).concat.apply(i,c(n)).concat([1,r.length>>>8&255,255&r.length])).concat.apply(a,c(r))),h=new Uint8Array([0,0,88,57,0,15,200,192,0,4,86,72]),p=t.sinf(e.encv),v=new Uint8Array([u>>24,u>>16&255,u>>8&255,255&u,l>>24,l>>16&255,l>>8&255,255&l]);return t.box(t.types.encv,d,t.box(t.types.avcC,f),t.box(t.types.btrt,h),p,t.box(t.types.pasp,v))}},{key:"schi",value:function(e){var a=new Uint8Array([]),i=t.tenc(e);return t.box(t.types.schi,a,i)}},{key:"tenc",value:function(e){var a=new Uint8Array([0,0,0,0,0,0,255&e.default_IsEncrypted,255&e.default_IV_size].concat(F(e.default_KID)));return t.box(t.types.tenc,a)}},{key:"sinf",value:function(e){var a=new Uint8Array([]),i=new Uint8Array([e.data_format.charCodeAt(0),e.data_format.charCodeAt(1),e.data_format.charCodeAt(2),e.data_format.charCodeAt(3)]),n=new Uint8Array([0,0,0,0,99,101,110,99,0,1,0,0]),r=t.schi(e);return t.box(t.types.sinf,a,t.box(t.types.frma,i),t.box(t.types.schm,n),r)}},{key:"avc1hev1",value:function(e){var a=e.codecType===y,i=a?t.types.hvc1:t.types.avc1,n=a?t.hvcC(e):t.avcC(e),r=[new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,e.width>>8&255,255&e.width,e.height>>8&255,255&e.height,0,72,0,0,0,72,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),n];return a?r.push(t.box(t.types.fiel,new Uint8Array([1,0]))):e.sarRatio&&e.sarRatio.length>1&&r.push(t.pasp(e.sarRatio)),t.box.apply(t,[i].concat(r))}},{key:"avcC",value:function(e){var a,i,n,r=[],s=[];return e.sps.forEach((function(e){n=e.byteLength,r.push(n>>>8&255),r.push(255&n),r.push.apply(r,c(e))})),e.pps.forEach((function(e){n=e.byteLength,s.push(n>>>8&255),s.push(255&n),s.push.apply(s,c(e))})),t.box(t.types.avcC,new Uint8Array((a=(i=[1,r[3],r[4],r[5],255,224|e.sps.length]).concat.apply(i,r).concat([e.pps.length])).concat.apply(a,s)))}},{key:"hvcC",value:function(e){var a=e.hvcC;if(a instanceof ArrayBuffer||a instanceof Uint8Array)return a;var i,n=e.vps,r=e.sps,s=e.pps;if(a){var o=a.generalProfileCompatibilityFlags,u=a.generalConstraintIndicatorFlags,l=(n.length&&1)+(r.length&&1)+(s.length&&1);i=[1,a.generalProfileSpace<<6|a.generalTierFlag<<5|a.generalProfileIdc,o>>>24,o>>>16,o>>>8,o,u[0],u[1],u[2],u[3],u[4],u[5],a.generalLevelIdc,240,0,252,252|a.chromaFormatIdc,248|a.bitDepthLumaMinus8,248|a.bitDepthChromaMinus8,0,0,a.numTemporalLayers<<3|a.temporalIdNested<<2|3,l];var d=function(e){var t;i.push(e.length>>8,e.length),(t=i).push.apply(t,c(e))};n.length&&(i.push(160,0,n.length),n.forEach(d)),r.length&&(i.push(161,0,r.length),r.forEach(d)),s.length&&(i.push(162,0,s.length),s.forEach(d))}else i=[1,1,96,0,0,0,144,0,0,0,0,0,93,240,0,252,253,248,248,0,0,15,3,160,0,1,0,24,64,1,12,1,255,255,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,153,152,9,161,0,1,0,45,66,1,1,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,160,2,128,128,45,22,89,153,164,147,43,154,128,128,128,130,0,0,3,0,2,0,0,3,0,50,16,162,0,1,0,7,68,1,193,114,180,98,64];return t.box(t.types.hvcC,new Uint8Array(i))}},{key:"pasp",value:function(e){var a=u(e,2),i=a[0],n=a[1];return t.box(t.types.pasp,new Uint8Array([i>>24,i>>16&255,i>>8&255,255&i,n>>24,n>>16&255,n>>8&255,255&n]))}},{key:"mp4a",value:function(e){return t.box(t.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,e.sampleRate>>8&255,255&e.sampleRate,0,0]),e.config.length?t.esds(e.config):void 0)}},{key:"esds",value:function(e){var a=e.length;return t.box(t.types.esds,new Uint8Array([0,0,0,0,3,23+a,0,0,0,4,15+a,64,21,0,6,0,0,0,218,192,0,0,218,192,5].concat([a]).concat(e).concat([6,1,2])))}},{key:"mvex",value:function(e){return t.box.apply(t,[t.types.mvex].concat(c(e.map((function(e){return t.trex(e.id)})))))}},{key:"trex",value:function(e){return t.box(t.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}},{key:"trex1",value:function(e){return t.box(t.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e,0,0,0,1,0,0,2,0,0,0,0,0,0,1,0,0]))}},{key:"trex2",value:function(e){return t.box(t.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e,0,0,0,1,0,0,4,0,0,0,0,0,2,0,0,0]))}},{key:"moof",value:function(e){return t.box.apply(t,[t.types.moof,t.mfhd(e[0].samples?e[0].samples[0].gopId:0)].concat(c(e.map((function(e){return t.traf(e)})))))}},{key:"mfhd",value:function(e){return t.box(t.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e]))}},{key:"traf",value:function(e){var a=t.tfhd(e.id),i=t.tfdt(e,e.baseMediaDecodeTime),n=0;if(e.isVideo&&e.videoSenc&&e.videoSenc.forEach((function(e){n+=8,e.subsamples&&e.subsamples.length&&(n+=2,n+=6*e.subsamples.length)})),e.videoSencLength=n,e.useEME&&(e.isVideoEncryption||e.isAudioEncryption)){if(e.isVideoEncryption){if(e.isVideo){var r=t.saiz(e),s=t.saio(e),o=t.trun1(e),u=t.senc(e);return t.box(t.types.traf,a,i,r,s,o,u)}if(e.isAudioEncryption){var c=t.sbgp(),l=t.saiz(e),d=t.saio(e),f=t.senc(e),h=t.trun1(e);return t.box(t.types.traf,a,i,c,l,d,f,h)}var p=t.sbgp(),v=t.trun1(e);return t.box(t.types.traf,a,i,p,v)}if(e.isVideo){var m=t.trun1(e);return t.box(t.types.traf,a,i,m)}var y=t.sbgp(),b=t.saiz(e),g=t.saio(e),k=t.senc(e),_=t.trun1(e);return t.box(t.types.traf,a,i,y,b,g,k,_)}var x=t.sdtp(e);return t.box(t.types.traf,a,i,x,t.trun(e.samples,x.byteLength+76))}},{key:"sdtp",value:function(e){var a=new se;return e.samples.forEach((function(t){a.write(new Uint8Array(e.isVideo?[t.keyframe?32:16]:[16]))})),t.box(t.types.sdtp,this.extension(0,0),a.buffer)}},{key:"trun1",value:function(e){var a=new se,i=se.writeUint32(e.samples.length),n=null;if(e.isVideo){var r=e.videoSencLength;n=se.writeUint32(16*e.samples.length+r+149),!e.isVideoEncryption&&e.isAudioEncryption&&(n=se.writeUint32(16*e.samples.length+92))}else{var s=12*e.samples.length+124;e.isAudioEncryption&&(s=12*e.samples.length+8*e.audioSenc.length+177),n=se.writeUint32(s)}return e.samples.forEach((function(t){a.write(se.writeUint32(t.duration)),a.write(se.writeUint32(t.size)),a.write(se.writeUint32(t.keyframe?33554432:65536)),e.isVideo&&a.write(se.writeUint32(t.cts?t.cts:0))})),t.box(t.types.trun,this.extension(0,e.flags),i,n,a.buffer)}},{key:"senc",value:function(e){var a=new se,i=e.samples.length,n=e.isVideo?16:8,r=e.isVideo?2:0,s=[],o=0;return e.isVideo?(s=e.videoSenc,o=e.videoSencLength):s=e.audioSenc,o=o||n*i,a.write(se.writeUint32(16+o),t.types.senc,this.extension(0,r)),a.write(se.writeUint32(i)),s.forEach((function(e){for(var t=0;t<e.InitializationVector.length;t++)a.write(new Uint8Array([e.InitializationVector[t]]));e.subsamples&&e.subsamples.length&&(a.write(se.writeUint16(e.subsamples.length)),e.subsamples.forEach((function(e){a.write(se.writeUint16(e.BytesOfClearData)),a.write(se.writeUint32(e.BytesOfProtectedData))})))})),a.buffer}},{key:"saio",value:function(e){var a=12*e.samples.length+141;!e.isVideo&&e.isAudioEncryption&&(a=149);var i=new Uint8Array([1,0,0,0,0,0,0,1,0,0,0,0,a>>24&255,a>>16&255,a>>8&255,255&a]);return t.box(t.types.saio,i)}},{key:"saiz",value:function(e){var a=e.samples.length,i=new Uint8Array([0,0,0,0,16,a>>24&255,a>>16&255,a>>8&255,255&a]);return t.box(t.types.saiz,i)}},{key:"sbgp",value:function(){var e=new Uint8Array([114,111,108,108,0,0,0,1,0,0,1,25,0,0,0,1]);return t.box(t.types.sbgp,this.extension(0,0),e)}},{key:"extension",value:function(e,t){return new Uint8Array([e,t>>16&255,t>>8&255,255&t])}},{key:"tfhd",value:function(e){return t.box(t.types.tfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e]))}},{key:"tfdt",value:function(e,a){var i=Math.floor(a/(oe+1)),n=Math.floor(a%(oe+1));return e.useEME&&(e.isVideoEncryption||e.isAudioEncryption)?t.box(t.types.tfdt,new Uint8Array([0,0,0,0,n>>24,n>>16&255,n>>8&255,255&n])):t.box(t.types.tfdt,new Uint8Array([1,0,0,0,i>>24,i>>16&255,i>>8&255,255&i,n>>24,n>>16&255,n>>8&255,255&n]))}},{key:"trun",value:function(e,a){var i=e.length,n=12+16*i;a+=8+n;var r=new Uint8Array(n);r.set([0,0,15,1,i>>>24&255,i>>>16&255,i>>>8&255,255&i,a>>>24&255,a>>>16&255,a>>>8&255,255&a],0);for(var s=0;s<i;s++){var o=e[s],u=o.duration,c=o.size,l=o.flag,d=void 0===l?{}:l,f=o.cts,h=void 0===f?0:f;r.set([u>>>24&255,u>>>16&255,u>>>8&255,255&u,c>>>24&255,c>>>16&255,c>>>8&255,255&c,d.isLeading<<2|(null===d.dependsOn||void 0===d.dependsOn?1:d.dependsOn),d.isDependedOn<<6|d.hasRedundancy<<4|d.paddingValue<<1|(null===d.isNonSyncSample||void 0===d.isNonSyncSample?1:d.isNonSyncSample),61440&d.degradationPriority,15&d.degradationPriority,h>>>24&255,h>>>16&255,h>>>8&255,255&h],12+16*s)}return t.box(t.types.trun,r)}},{key:"moovMP4",value:function(e){return t.box.apply(t,[t.types.moov,t.mvhd(e[0].duration,e[0].timescale)].concat(c(e.map((function(e){return t.trackMP4(e)})))))}},{key:"trackMP4",value:function(e){return t.box(t.types.trak,t.tkhd(e.id,e.duration,e.width,e.height),t.mdiaMP4(e))}},{key:"mdiaMP4",value:function(e){return t.box(t.types.mdia,t.mdhd(e.duration,e.timescale),t.hdlr(e.type),t.minfMP4(e))}},{key:"minfMP4",value:function(e){return t.box(t.types.minf,e.type===h?t.VMHD:t.SMHD,t.DINF,t.stblMP4(e))}},{key:"stblMP4",value:function(e){var a=e.ext,i=[t.stsd(e),t.stts(a.stts),t.stsc(a.stsc),t.stsz(a.stsz),t.stco(a.stco)];return a.stss.length&&i.push(t.stss(a.stss)),a.ctts.length&&i.push(t.ctts(a.ctts)),t.box.apply(t,[t.types.stbl].concat(i))}},{key:"stts",value:function(e){var a=e.length,i=new Uint8Array(8*a),n=0;return e.forEach((function(e){var t=e.value,a=e.count;i.set([a>>24,a>>16&255,a>>8&255,255&a,t>>24,t>>16&255,t>>8&255,255&t],n),n+=8})),t.box(t.types.stts,z(new Uint8Array([0,0,0,0,a>>24,a>>16&255,a>>8&255,255&a]),i))}},{key:"stsc",value:function(e){var a=e.length,i=new Uint8Array(12*a),n=0;return e.forEach((function(e){var t=e.firstChunk,a=e.samplesPerChunk,r=e.sampleDescIndex;i.set([t>>24,t>>16&255,t>>8&255,255&t,a>>24,a>>16&255,a>>8&255,255&a,r>>24,r>>16&255,r>>8&255,255&r],n),n+=12})),t.box(t.types.stsc,z(new Uint8Array([0,0,0,0,a>>24,a>>16&255,a>>8&255,255&a]),i))}},{key:"stsz",value:function(e){var a=e.length,i=new Uint8Array(4*a),n=0;return e.forEach((function(e){i.set([e>>24,e>>16&255,e>>8&255,255&e],n),n+=4})),t.box(t.types.stsz,z(new Uint8Array([0,0,0,0,0,0,0,0,a>>24,a>>16&255,a>>8&255,255&a]),i))}},{key:"stco",value:function(e){var a=e.length,i=new Uint8Array(4*a),n=0;return e.forEach((function(e){i.set([e>>24,e>>16&255,e>>8&255,255&e],n),n+=4})),t.box(t.types.stco,z(new Uint8Array([0,0,0,0,a>>24,a>>16&255,a>>8&255,255&a]),i))}},{key:"stss",value:function(e){var a=e.length,i=new Uint8Array(4*a),n=0;return e.forEach((function(e){i.set([e>>24,e>>16&255,e>>8&255,255&e],n),n+=4})),t.box(t.types.stss,z(new Uint8Array([0,0,0,0,a>>24,a>>16&255,a>>8&255,255&a]),i))}},{key:"ctts",value:function(e){var a=e.length,i=new Uint8Array(8*a),n=0;return e.forEach((function(e){var t=e.value,a=e.count;i.set([a>>24,a>>16&255,a>>8&255,255&a,t>>24,t>>16&255,t>>8&255,255&t],n),n+=8})),t.box(t.types.ctts,z(new Uint8Array([0,0,0,0,a>>24,a>>16&255,a>>8&255,255&a]),i))}},{key:"styp",value:function(){return t.box(t.types.styp,new Uint8Array([109,115,100,104,0,0,0,0,109,115,100,104,109,115,105,120]))}},{key:"sidx",value:function(e){var a=e.timescale,i=e.samples[0].duration,n=i*e.samples.length,r=e.samples[0].sampleOffset*i,s=8;e.samples.forEach((function(e){s+=e.size}));var o=0;if(e.isVideo){var u,c=0;e.videoSenc&&(u=e.videoSenc),e.isVideo&&u.forEach((function(e){c+=8,e.subsamples&&e.subsamples.length&&(c+=2,c+=6*e.subsamples.length)})),e.videoSencLength=c,o=s+141+16*e.samples.length+c,e.useEME&&e.isAudioEncryption&&!e.isVideoEncryption&&(o=s+16*e.samples.length+84)}else o=s+116+12*e.samples.length,e.useEME&&e.isAudioEncryption&&(o=s+169+12*e.samples.length+8*e.audioSenc.length);var l=new Uint8Array([0,0,0,0,0,0,0,255&e.id,a>>24&255,a>>16&255,a>>8&255,255&a,r>>24&255,r>>16&255,r>>8&255,255&r,0,0,0,0,0,0,0,1,0,o>>16&255,o>>8&255,255&o,n>>24&255,n>>16&255,n>>8&255,255&n,144,0,0,0]);return t.box(t.types.sidx,l)}},{key:"mdat",value:function(e){return t.box(t.types.mdat,e)}}]),t}();i(ue,"types",["avc1","avcC","hvc1","hvcC","dinf","dref","esds","ftyp","hdlr","mdat","mdhd","mdia","mfhd","minf","moof","moov","mp4a","mvex","mvhd","pasp","stbl","stco","stsc","stsd","stsz","stts","tfdt","tfhd","traf","trak","trex","tkhd","vmhd","smhd","ctts","stss","styp","pssh","sidx","sbgp","saiz","saio","senc","trun","encv","enca","sinf","btrt","frma","tenc","schm","schi","mehd","fiel","sdtp"].reduce((function(e,t){return e[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)],e}),Object.create(null))),i(ue,"HDLR_TYPES",{video:new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),audio:new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0])}),i(ue,"FTYPAVC1",ue.box(ue.types.ftyp,new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,97,118,99,49]))),i(ue,"FTYPHEV1",ue.box(ue.types.ftyp,new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,104,101,118,49]))),i(ue,"DINF",ue.box(ue.types.dinf,ue.box(ue.types.dref,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1])))),i(ue,"VMHD",ue.box(ue.types.vmhd,new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]))),i(ue,"SMHD",ue.box(ue.types.smhd,new Uint8Array([0,0,0,0,0,0,0,0]))),i(ue,"StblTable",new Uint8Array([0,0,0,0,0,0,0,0])),i(ue,"STTS",ue.box(ue.types.stts,ue.StblTable)),i(ue,"STSC",ue.box(ue.types.stsc,ue.StblTable)),i(ue,"STSZ",ue.box(ue.types.stsz,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]))),i(ue,"STCO",ue.box(ue.types.stco,ue.StblTable));var ce=function(){function t(a,i){e(this,t),this.name=a||"",this._prefix="[".concat(this.name,"]"),t.disabled=i}return a(t,[{key:"debug",value:function(){var e;if(!t.disabled){for(var a=arguments.length,i=new Array(a),n=0;n<a;n++)i[n]=arguments[n];(e=console).debug.apply(e,[this._prefix].concat(i))}}},{key:"log",value:function(){var e;if(!t.disabled){for(var a=arguments.length,i=new Array(a),n=0;n<a;n++)i[n]=arguments[n];(e=console).log.apply(e,[this._prefix].concat(i))}}},{key:"warn",value:function(){var e;if(!t.disabled){for(var a=arguments.length,i=new Array(a),n=0;n<a;n++)i[n]=arguments[n];(e=console).warn.apply(e,[this._prefix].concat(i))}}},{key:"error",value:function(){var e;if(!t.disabled){for(var a=arguments.length,i=new Array(a),n=0;n<a;n++)i[n]=arguments[n];(e=console).error.apply(e,[this._prefix].concat(i))}}},{key:"table",value:function(){var e;t.disabled||(console.group(this._prefix),(e=console).table.apply(e,arguments),console.groupEnd())}}],[{key:"enable",value:function(){t.disabled=!1}},{key:"disable",value:function(){t.disabled=!0}}]),t}();i(ce,"disabled",!0);var le=function(){function t(a,i,n){e(this,t),this.videoTrack=a,this.audioTrack=i;var r=/Chrome\/([^.]+)/.exec(navigator.userAgent);this.forceFirstIDR=r&&Number(r[1])<50,this.log=new ce("FMP4Remuxer",!n||!n.openLog||!n.openLog)}return a(t,[{key:"remux",value:function(){var e,t,a,i,n,r=arguments.length>0&&void 0!==arguments[0]&&arguments[0],s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=this.videoTrack,u=this.audioTrack,c=o.exist(),l=u.exist(),d=[];return r&&(s&&s.initMerge?(c&&d.push(this.videoTrack),l&&d.push(this.audioTrack),a=ue.initSegment(d)):(c&&(e=ue.initSegment([this.videoTrack])),l&&(t=ue.initSegment([this.audioTrack])))),c&&o.hasSample()&&(i=this._remuxVideo()),l&&u.hasSample()&&(n=this._remuxAudio()),o.samples=[],u.samples=[],{initSegment:a,videoInitSegment:e,audioInitSegment:t,videoSegment:i,audioSegment:n}}},{key:"_remuxVideo",value:function(){var e=this.videoTrack;this.forceFirstIDR&&(e.samples[0].flag={dependsOn:2,isNonSyncSample:0});var t=e.samples,a=0;t.forEach((function(e){a+=e.units.reduce((function(e,t){return e+t.byteLength}),0),a+=4*e.units.length}));for(var i,n=new Uint8Array(a),r=new DataView(n.buffer),s=function(e,a){a=t[o];var s=0;a.units.forEach((function(t){r.setUint32(e,t.byteLength),e+=4,n.set(t,e),e+=t.byteLength,s+=4+t.byteLength})),a.size=s,c=e,i=a},o=0,u=t.length,c=0;o<u;o++)s(c,i);var l=ue.mdat(n);return z(ue.moof([e]),l)}},{key:"_remuxAudio",value:function(){var e=this.audioTrack,t=new Uint8Array(e.samples.reduce((function(e,t){return e+t.size}),0));e.samples.reduce((function(e,a){return t.set(a.data,e),e+a.size}),0);var a=ue.mdat(t);return z(ue.moof([e]),a)}},{key:"reset",value:function(){this.videoTrack.reset(),this.audioTrack.reset()}}]),t}();export{re as F,B as L,X as M,J as T,_ as W,le as a};
